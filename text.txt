// public/app.js

// Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
const showPostsBtn = document.getElementById('showPostsBtn');
const showChatsBtn = document.getElementById('showChatsBtn');
const showAcquaintancesBtn = document.getElementById('showAcquaintancesBtn'); // Ø²Ø± Ø§Ù„Ù…Ø¹Ø§Ø±Ù
const showProfileBtn = document.getElementById('showProfileBtn');
const toggleDarkModeBtn = document.getElementById('toggleDarkModeBtn');

const postsSection = document.getElementById('postsSection');
const chatsSection = document.getElementById('chatsSection');
const acquaintancesSection = document.getElementById('acquaintancesSection'); // Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ø±Ù
const profileSection = document.getElementById('profileSection');

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
const postContentInput = document.getElementById('postContent');
const privatePostCheckbox = document.getElementById('privatePostCheckbox'); // ØµÙ†Ø¯ÙˆÙ‚ ØªØ­Ø¯ÙŠØ¯ Ù…Ù†Ø´ÙˆØ± Ø®Ø§Øµ
const publishPostBtn = document.getElementById('publishPostBtn');
const postsList = document.getElementById('postsList');
const refreshPostsBtn = document.getElementById('refreshPostsBtn');

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
const profileAvatar = document.getElementById('profileAvatar');
const profileUsername = document.getElementById('profileUsername');
const profileEmail = document.getElementById('profileEmail');
const postsCountSpan = document.getElementById('postsCount');
const acquaintancesCountSpan = document.getElementById('acquaintancesCount'); // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø±Ù
const savedPostsCountSpan = document.getElementById('savedPostsCount'); // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
const editUsernameBtn = document.getElementById('editUsernameBtn');
const newUsernameInput = document.getElementById('newUsernameInput');
const saveUsernameBtn = document.getElementById('saveUsernameBtn');
const changeAvatarBtn = document.getElementById('changeAvatarBtn');
const profileImageUpload = document.getElementById('profileImageUpload');
const profileStatusMessage = document.getElementById('profileStatusMessage');
const editStatusMessageBtn = document.getElementById('editStatusMessageBtn');
const privateProfileCheckbox = document.getElementById('privateProfileCheckbox'); // ØµÙ†Ø¯ÙˆÙ‚ ØªØ­Ø¯ÙŠØ¯ Ù‚ÙÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
const savedPostsList = document.getElementById('savedPostsList'); // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©

// Ø¹Ù†Ø§ØµØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·)
const showSettingsBtn = document.getElementById('showSettingsBtn');
const settingsCard = document.getElementById('settingsCard');
const apiKeyInput = document.getElementById('apiKeyInput');
const authDomainInput = document.getElementById('authDomainInput');
const databaseURLInput = document.getElementById('databaseURLInput');
const projectIdInput = document.getElementById('projectIdInput');
const storageBucketInput = document.getElementById('storageBucketInput');
const messagingSenderIdInput = document.getElementById('messagingSenderIdInput');
const appIdInput = document.getElementById('appIdInput');
const saveFirebaseConfigBtn = document.getElementById('saveFirebaseConfigBtn');
const firebaseConfigMessage = document.getElementById('firebaseConfigMessage');

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
const searchUserInput = document.getElementById('searchUserInput');
const searchUserBtn = document.getElementById('searchUserBtn');
const searchResultsList = document.getElementById('searchResults');
const chatsList = document.getElementById('chatsList');
const chatContainer = document.getElementById('chatContainer');
const closeChatBtn = document.getElementById('closeChatBtn');
const chatHeaderName = document.getElementById('chatHeaderName');
const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
const chatStatus = document.getElementById('chatStatus');
const messagesList = document.getElementById('messagesList');
const messageInputForm = document.getElementById('messageInputForm');
const messageInput = document.getElementById('messageInput');
const sendMessageBtn = document.getElementById('sendMessageBtn');
const recordAudioBtn = document.getElementById('recordAudioBtn');
const emojiPickerBtn = document.getElementById('emojiPickerBtn');
const emojiPicker = document.getElementById('emojiPicker');

// Ø¹Ù†Ø§ØµØ± Ù‚Ø³Ù… Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù† (Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ)
const onlineUsersSidebar = document.getElementById('onlineUsersSidebar');
const onlineUsersList = document.getElementById('onlineUsersList');
const onlineUsersCountSpan = document.getElementById('onlineUsersCount');

// Ù…ØªØºÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
let currentChatId = null;
let currentChatName = null;
let currentChatAvatar = null;
let isCurrentChatGroup = false;
let isCurrentChatNewsChannel = false;
let currentOtherParticipantId = null;

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
let unsubscribeMessages = null;
let unsubscribeChatStatus = null;
let unsubscribeTypingStatus = null;
let unsubscribeAcquaintances = null;
let unsubscribeOnlineUsers = null;
let unsubscribeSavedPosts = null;

// Ù…Ø¤Ù‚Øª Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
let typingTimer;
const TYPING_TIMEOUT = 3000; // 3 Ø«ÙˆØ§Ù†ÙŠ

// Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
const REACTION_EMOJIS = {
    heart: 'â¤',
    tears: 'ğŸ˜«',
    clown: 'ğŸ¤¡',
    thumbsUp: 'ğŸ‘',
    thumbsDown: 'ğŸ‘'
};


// --- ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ---

/**
 * ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.
 * @param {string} sectionId - Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¸Ù‡Ø§Ø±Ù‡ (Ù…Ø«Ù„Ø§Ù‹: 'postsSection').
 */
function showSection(sectionId) {
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    document.getElementById(sectionId).classList.add('active');

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ø±Ø£Ø³ (Nav Buttons)
    document.querySelectorAll('header nav .nav-button').forEach(btn => btn.classList.remove('active'));
    if (sectionId === 'postsSection') showPostsBtn.classList.add('active');
    else if (sectionId === 'chatsSection') showChatsBtn.classList.add('active');
    else if (sectionId === 'acquaintancesSection') showAcquaintancesBtn.classList.add('active');
    else if (sectionId === 'profileSection') showProfileBtn.classList.add('active');

    // Ø¥Ø®ÙØ§Ø¡ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
    searchResultsList.innerHTML = '';
    searchUserInput.value = '';

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø¢Ø®Ø± ØºÙŠØ± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
    if (sectionId !== 'chatsSection' && chatContainer.classList.contains('active')) {
        closeChat();
    }
    // Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    emojiPicker.classList.remove('active');

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù‚Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„ÙŠÙ‡
    if (sectionId === 'postsSection') {
        loadPosts();
    } else if (sectionId === 'chatsSection') {
        loadChats();
    } else if (sectionId === 'profileSection') {
        if (currentUser) {
            loadUserProfile(currentUser.uid);
            loadSavedPosts(currentUser.uid); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        }
    } else if (sectionId === 'acquaintancesSection') {
        if (currentUser) {
            loadAcquaintances(); // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø±Ù
        }
    }
}

/**
 * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ù„Ø¹Ø±Ø¶Ù‡ Ø¨Ø´ÙƒÙ„ Ù†Ø³Ø¨ÙŠ (Ù…Ø«Ù„Ø§Ù‹: "5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ø¶Øª").
 * @param {firebase.firestore.Timestamp} timestamp - ÙƒØ§Ø¦Ù† Timestamp Ù…Ù† Firestore.
 * @returns {string} - Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ù†Ø³Ù‚Ø©.
 */
function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    const now = new Date();
    const diffSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

    if (diffSeconds < 60) return 'Ø§Ù„Ø¢Ù†';
    else if (diffSeconds < 3600) return `${Math.floor(diffSeconds / 60)} Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø¶Øª`;
    else if (diffSeconds < 86400) return `${Math.floor(diffSeconds / 3600)} Ø³Ø§Ø¹Ø© Ù…Ø¶Øª`;
    else if (diffSeconds < 604800) return `${Math.floor(diffSeconds / 86400)} ÙŠÙˆÙ… Ù…Ø¶Øª`;
    else return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
}

/**
 * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ù„Ø¹Ø±Ø¶Ù‡ Ø¨Ø´ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ (Ù…Ø«Ù„Ø§Ù‹: "Ø§Ù„ÙŠÙˆÙ…ØŒ 10:30 Øµ").
 * @param {firebase.firestore.Timestamp} timestamp - ÙƒØ§Ø¦Ù† Timestamp Ù…Ù† Firestore.
 * @returns {string} - Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ù†Ø³Ù‚Ø©.
 */
function formatPreciseTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);

    const isToday = date.toDateString() === today.toDateString();
    const isYesterday = date.toDateString() === yesterday.toDateString();

    const time = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });

    if (isToday) return `Ø§Ù„ÙŠÙˆÙ…ØŒ ${time}`;
    else if (isYesterday) return `Ø£Ù…Ø³ØŒ ${time}`;
    else return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' }) + `ØŒ ${time}`;
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ
toggleDarkModeBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
});

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹ Ø³Ø§Ø¨Ù‚Ø§Ù‹
if (localStorage.getItem('darkMode') === 'enabled') {
    document.body.classList.add('dark-mode');
}

// --- ÙˆØ¸Ø§Ø¦Ù Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ---

/**
 * Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø²Ø± "Ù†Ø´Ø±" Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.
 */
publishPostBtn.addEventListener('click', async () => {
    const content = postContentInput.value.trim();
    if (!content) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø´ÙŠØ¡ Ù„Ù†Ø´Ø±Ù‡.');
        return;
    }

    publishPostBtn.disabled = true;
    publishPostBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...';
    
    try {
        const isPrivate = privatePostCheckbox.checked; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©
        await createPost(content, isPrivate);
        postContentInput.value = '';
        privatePostCheckbox.checked = false; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©
        alert('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!');
    } catch (error) {
        alert('ÙØ´Ù„ Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±: ' + error.message);
    } finally {
        publishPostBtn.disabled = false;
        publishPostBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Ù†Ø´Ø±';
    }
});

/**
 * Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø²Ø± "ØªØ­Ø¯ÙŠØ«" Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.
 */
refreshPostsBtn.addEventListener('click', loadPosts);

/**
 * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.
 * @param {Array<Object>} posts - Ù…ØµÙÙˆÙØ© Ù…Ù† ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.
 */
function displayPosts(posts) {
    postsList.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    
    if (posts.length === 0) {
        postsList.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ†Ø´Ø±!</div>';
        return;
    }
    
    posts.forEach(post => {
        // Ù…Ù†Ø·Ù‚ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¹Ù† ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ø±Ù Ø£Ùˆ ØºÙŠØ± ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
        const isMyPost = currentUser && post.userId === currentUser.uid;
        const isAcquaintance = currentUserProfileData && currentUserProfileData.acquaintances && currentUserProfileData.acquaintances[post.userId];
        
        if (post.isPrivate && !isMyPost && !isAcquaintance) {
            return; // ØªØ®Ø·ÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®Ø§ØµÙ‹Ø§ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ ØµØ§Ø­Ø¨Ù‡ Ø£Ùˆ Ù…Ø¹Ø±ÙÙ‹Ø§ Ù„Ù‡
        }

        const postItem = document.createElement('div');
        postItem.className = 'post-item';
        postItem.setAttribute('data-post-id', post.id);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
        let reactionsHtml = '';
        const userSelectedReaction = post.userReactions?.[currentUser?.uid];
        for (const emojiType in REACTION_EMOJIS) {
            const isActive = userSelectedReaction === emojiType;
            reactionsHtml += `
                <button class="reaction-btn ${isActive ? 'active' : ''}" data-reaction-type="${emojiType}" data-post-id="${post.id}">
                    ${REACTION_EMOJIS[emojiType]} <span class="reaction-count">${post.reactions?.[emojiType] || 0}</span>
                </button>
            `;
        }

        postItem.innerHTML = `
            <div class="post-header">
                <img src="${post.userProfilePic || defaultAvatarUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ" class="post-avatar">
                <span class="post-username">${post.username}</span>
                ${isMyPost ? `
                    <div class="post-actions">
                        <button class="edit-post-btn" data-post-id="${post.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="delete-post-btn" data-post-id="${post.id}">Ø­Ø°Ù</button>
                        <!-- Ø²Ø± Ø¬Ø¹Ù„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø®Ø§Øµ ÙŠØ­ØªØ§Ø¬ Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù„ØªØºÙŠÙŠØ± isPrivate -->
                    </div>
                ` : ''}
            </div>
            <p class="post-content">${post.content}</p>
            <div class="post-footer">
                <span class="time">${formatTime(post.timestamp)} ${post.editedAt ? '(Ù…Ø¹Ø¯Ù‘Ù„)' : ''}</span>
                <div class="post-interactions">
                    <div class="reactions-container">
                        ${reactionsHtml}
                    </div>
                    <button class="comment-btn" data-post-id="${post.id}">
                        <i class="fas fa-comment-dots"></i> ØªØ¹Ù„ÙŠÙ‚Ø§Øª (${post.commentsCount || 0})
                    </button>
                    <button class="save-post-btn" data-post-id="${post.id}" data-saved="${currentUserProfileData?.savedPosts?.[post.id] ? 'true' : 'false'}">
                        <i class="${currentUserProfileData?.savedPosts?.[post.id] ? 'fas' : 'far'} fa-bookmark"></i> Ø­ÙØ¸
                    </button>
                </div>
            </div>
            <div class="comments-section" id="comments-${post.id}">
                <h4>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (<span class="comments-count">${post.commentsCount || 0}</span>)</h4>
                <div class="comment-input-area">
                    <textarea placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ù‹Ø§..." data-post-id="${post.id}"></textarea>
                    <button class="primary-button add-comment-btn" data-post-id="${post.id}">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
                    </button>
                </div>
                <div class="comments-list" id="commentsList-${post.id}">
                    <!-- Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                    <div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.</div>
                </div>
            </div>
        `;
        postsList.appendChild(postItem);

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        postItem.querySelectorAll('.reaction-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if (currentUser) {
                    const postId = e.currentTarget.dataset.postId;
                    const reactionType = e.currentTarget.dataset.reactionType;
                    try {
                        await addReaction(postId, currentUser.uid, reactionType);
                    } catch (error) {
                        alert(error.message);
                    }
                } else {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.');
                }
            });
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        const commentInput = postItem.querySelector(`.comments-section textarea`);
        const addCommentButton = postItem.querySelector(`.add-comment-btn`);
        addCommentButton.addEventListener('click', async () => {
            const commentContent = commentInput.value.trim();
            if (commentContent && currentUser) {
                addCommentButton.disabled = true;
                addCommentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ­Ù…ÙŠÙ„
                try {
                    await addComment(post.id, currentUser.uid, currentUserProfileData.username, currentUserProfileData.profilePictureUrl, commentContent);
                    commentInput.value = '';
                } catch (error) {
                    alert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: ' + error.message);
                } finally {
                    addCommentButton.disabled = false;
                    addCommentButton.innerHTML = '<i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚';
                }
            } else if (!commentContent) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚.');
            } else {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚.');
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„Ù„Ù…Ù†Ø´ÙˆØ±
        getComments(post.id, comments => {
            const commentsListElement = postItem.querySelector(`#commentsList-${post.id}`);
            commentsListElement.innerHTML = '';
            if (comments.length === 0) {
                commentsListElement.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.</div>';
            } else {
                comments.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment-item';
                    commentEl.innerHTML = `
                        <img src="${comment.userProfilePic || defaultAvatarUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚" class="comment-avatar">
                        <div class="comment-content-wrapper">
                            <span class="comment-author">${comment.username}</span>
                            <p class="comment-text">${comment.content}</p>
                            <div class="comment-time">${formatTime(comment.timestamp)}</div>
                        </div>
                    `;
                    commentsListElement.appendChild(commentEl);
                });
            }
            postItem.querySelector('.comments-count').textContent = comments.length;
        });

        // Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± (ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)
        if (isMyPost) {
            // Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            postItem.querySelector('.edit-post-btn').addEventListener('click', () => {
                const currentContentElement = postItem.querySelector('.post-content');
                const originalContent = currentContentElement.textContent;

                const textarea = document.createElement('textarea');
                textarea.className = 'edit-post-textarea';
                textarea.value = originalContent;
                textarea.rows = 4;

                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
                saveBtn.className = 'primary-button';

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡';
                cancelBtn.className = 'secondary-button';

                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ¹Ø±Ø¶ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
                currentContentElement.style.display = 'none';
                postItem.querySelector('.post-actions').style.display = 'none';
                
                const footer = postItem.querySelector('.post-footer');
                footer.insertBefore(textarea, footer.firstChild);
                footer.appendChild(saveBtn);
                footer.appendChild(cancelBtn);

                saveBtn.addEventListener('click', async () => {
                    const newContent = textarea.value.trim();
                    if (newContent && currentUser) {
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                        try {
                            await updatePost(post.id, newContent, currentUser.uid);
                            alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');
                            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
                            loadPosts();
                        } catch (error) {
                            alert('ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±: ' + error.message);
                        } finally {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
                            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ
                            textarea.remove();
                            saveBtn.remove();
                            cancelBtn.remove();
                            currentContentElement.style.display = 'block';
                            postItem.querySelector('.post-actions').style.display = 'flex';
                        }
                    } else {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ù…Ø­ØªÙˆÙ‰ ØµØ§Ù„Ø­ Ù„Ù„Ù…Ù†Ø´ÙˆØ±.');
                    }
                });

                cancelBtn.addEventListener('click', () => {
                    textarea.remove();
                    saveBtn.remove();
                    cancelBtn.remove();
                    currentContentElement.style.display = 'block';
                    postItem.querySelector('.post-actions').style.display = 'flex';
                });
            });

            // Ø²Ø± Ø§Ù„Ø­Ø°Ù
            postItem.querySelector('.delete-post-btn').addEventListener('click', async () => {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø£ÙŠØ¶Ø§Ù‹.')) {
                    try {
                        await deletePost(post.id, currentUser.uid);
                        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
                        loadPosts();
                    } catch (error) {
                        alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±: ' + error.message);
                    }
                }
            });
        }

        // Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
        const savePostButton = postItem.querySelector('.save-post-btn');
        const bookmarkIcon = savePostButton.querySelector('i');
        
        savePostButton.addEventListener('click', async () => {
            if (!currentUser) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.');
                return;
            }
            try {
                if (savePostButton.dataset.saved === 'true') { // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸Ø§Ù‹
                    await unsavePost(currentUser.uid, post.id);
                    bookmarkIcon.classList.remove('fas');
                    bookmarkIcon.classList.add('far');
                    savePostButton.dataset.saved = 'false';
                    alert('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±.');
                } else { // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­ÙÙˆØ¸Ø§Ù‹
                    await savePost(currentUser.uid, post.id);
                    bookmarkIcon.classList.remove('far');
                    bookmarkIcon.classList.add('fas');
                    savePostButton.dataset.saved = 'true';
                    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');
                }
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
                loadUserProfile(currentUser.uid);
            } catch (error) {
                alert('ÙØ´Ù„ Ø­ÙØ¸/Ø¥Ø²Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±: ' + error.message);
            }
        });
    });
}

/**
 * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.
 */
function loadPosts() {
    postsList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª...</div>';
    getPosts(displayPosts);
}


// --- ÙˆØ¸Ø§Ø¦Ù Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ---

/**
 * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 */
async function loadUserProfile(userId) {
    const doc = await getUserProfile(userId);
    if (doc.exists) {
        currentUserProfileData = doc.data(); // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        displayUserProfile(currentUserProfileData);
    } else {
        console.error("User profile not found for ID:", userId);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ø´Ø®ØµÙŠØŒ ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ ÙÙŠ auth.js
        profileUsername.textContent = currentUser.email.split('@')[0];
        profileEmail.textContent = currentUser.email;
        profileAvatar.src = defaultAvatarUrl;
        postsCountSpan.textContent = '0';
        acquaintancesCountSpan.textContent = '0';
        savedPostsCountSpan.textContent = '0';
        profileStatusMessage.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ù…Ø­Ø¯Ø¯Ø©.';
    }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
    if (isAdminUser()) {
        showSettingsBtn.style.display = 'block';
        populateFirebaseConfigInputs();
    } else {
        showSettingsBtn.style.display = 'none';
        settingsCard.style.display = 'none';
    }
}

/**
 * Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.
 * @param {Object} user - ÙƒØ§Ø¦Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore.
 */
function displayUserProfile(user) {
    profileUsername.textContent = user.username || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
    profileEmail.textContent = user.email || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
    profileAvatar.src = user.profilePictureUrl || defaultAvatarUrl;
    postsCountSpan.textContent = user.postsCount || 0;
    // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø±Ù ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡ Ù…Ù† Ø­Ù‚Ù„ `acquaintances` ÙÙŠ Firestore
    acquaintancesCountSpan.textContent = Object.keys(user.acquaintances || {}).length || 0; 
    savedPostsCountSpan.textContent = Object.keys(user.savedPosts || {}).length || 0;
    profileStatusMessage.textContent = user.statusMessage || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ù…Ø­Ø¯Ø¯Ø©.';
    privateProfileCheckbox.checked = user.isProfilePrivate || false;
}

// Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
editUsernameBtn.addEventListener('click', () => {
    profileUsername.style.display = 'none';
    editUsernameBtn.style.display = 'none';
    newUsernameInput.style.display = 'block';
    saveUsernameBtn.style.display = 'block';
    newUsernameInput.value = profileUsername.textContent;
    newUsernameInput.focus();
});

saveUsernameBtn.addEventListener('click', async () => {
    const newUsername = newUsernameInput.value.trim();
    if (newUsername && currentUser) {
        if (newUsername === currentUserProfileData.username) {
            alert('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ùˆ Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ.');
            profileUsername.style.display = 'block';
            editUsernameBtn.style.display = 'block';
            newUsernameInput.style.display = 'none';
            saveUsernameBtn.style.display = 'none';
            return;
        }

        saveUsernameBtn.disabled = true;
        saveUsernameBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        try {
            const success = await updateUsername(currentUser.uid, newUsername);
            if (success) {
                profileUsername.textContent = newUsername;
                currentUserProfileData.username = newUsername; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.');
            }
        } catch (error) {
            alert('Ø®Ø·Ø£: ' + error.message);
        } finally {
            saveUsernameBtn.disabled = false;
            saveUsernameBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…';
            profileUsername.style.display = 'block';
            editUsernameBtn.style.display = 'block';
            newUsernameInput.style.display = 'none';
            saveUsernameBtn.style.display = 'none';
        }
    } else {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ØµØ§Ù„Ø­.');
    }
});

// Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ù„ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ø¬
editStatusMessageBtn.addEventListener('click', async () => {
    const currentStatus = currentUserProfileData.statusMessage || '';
    const newStatus = prompt('Ø£Ø¯Ø®Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', currentStatus);
    if (newStatus !== null && newStatus.trim() !== currentStatus.trim()) {
        try {
            await updateStatusMessage(currentUser.uid, newStatus.trim());
            profileStatusMessage.textContent = newStatus.trim();
            currentUserProfileData.statusMessage = newStatus.trim();
            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ø¬ Ø¨Ù†Ø¬Ø§Ø­.');
        } catch (error) {
            alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ø¬: ' + error.message);
        }
    }
});

// Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ù„ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
changeAvatarBtn.addEventListener('click', () => {
    profileImageUpload.click(); // ÙŠØ­ÙØ² Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ÙÙŠ
});

profileImageUpload.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file && currentUser) {
        alert("ÙˆØ¸ÙŠÙØ© ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø®Ù„Ø§Ù„ Firebase Free Tier Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ§Ù‚. ØªØ­ØªØ§Ø¬ Ù„Ø®Ø¯Ù…Ø© Ø±ÙØ¹ Ø®Ø§Ø±Ø¬ÙŠØ© (Ù…Ø«Ù„ Imgur Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±) Ø£Ùˆ Firebase Storage.");
        // Ù…Ø«Ø§Ù„: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© Ø®Ø§Ø±Ø¬ÙŠØ© Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ù„Ù‡Ø§:
        // const imageUrl = await uploadImageToExternalService(file);
        // if (imageUrl) {
        //     await updateProfilePicture(currentUser.uid, imageUrl);
        //     profileAvatar.src = imageUrl; // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
        //     currentUserProfileData.profilePictureUrl = imageUrl; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        //     alert('ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­.');
        // } else {
        //     alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©.');
        // }
    }
});

// Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ù„ØªØ¨Ø¯ÙŠÙ„ Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
privateProfileCheckbox.addEventListener('change', async () => {
    if (!currentUser) return;
    const isPrivate = privateProfileCheckbox.checked;
    try {
        await toggleProfilePrivacy(currentUser.uid, isPrivate);
        currentUserProfileData.isProfilePrivate = isPrivate; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        alert(`ØªÙ… ${isPrivate ? 'Ù‚ÙÙ„' : 'Ø¥Ù„ØºØ§Ø¡ Ù‚ÙÙ„'} Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­.`);
    } catch (error) {
        alert('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ: ' + error.message);
    }
});

/**
 * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 */
function loadSavedPosts(userId) {
    if (unsubscribeSavedPosts) {
        unsubscribeSavedPosts(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
    }
    savedPostsList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...</div>';
    unsubscribeSavedPosts = getSavedPosts(userId, (posts) => {
        savedPostsList.innerHTML = '';
        if (posts.length === 0) {
            savedPostsList.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.</div>';
            savedPostsCountSpan.textContent = '0';
            return;
        }
        savedPostsCountSpan.textContent = posts.length;
        posts.forEach(post => {
            const postItem = document.createElement('div');
            postItem.className = 'post-item';
            postItem.innerHTML = `
                <div class="post-header">
                    <img src="${post.userProfilePic || defaultAvatarUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ" class="post-avatar">
                    <span class="post-username">${post.username}</span>
                </div>
                <p class="post-content">${post.content}</p>
                <div class="post-footer">
                    <span class="time">${formatTime(post.timestamp)}</span>
                    <button class="save-post-btn saved" data-post-id="${post.id}" data-saved="true">
                        <i class="fas fa-bookmark"></i> Ø¥Ø²Ø§Ù„Ø© Ø­ÙØ¸
                    </button>
                </div>
            `;
            savedPostsList.appendChild(postItem);

            // Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø²Ø± Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸
            postItem.querySelector('.save-post-btn').addEventListener('click', async (e) => {
                if (!currentUser) return;
                const postId = e.currentTarget.dataset.postId;
                try {
                    await unsavePost(currentUser.uid, postId);
                    alert('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±.');
                    // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± listener Ù„Ù€ getSavedPosts
                } catch (error) {
                    alert('ÙØ´Ù„ Ø¥Ø²Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±: ' + error.message);
                }
            });
        });
    });
}


// --- ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·) ---

showSettingsBtn.addEventListener('click', () => {
    if (isAdminUser()) {
        settingsCard.style.display = settingsCard.style.display === 'none' ? 'block' : 'none';
        if (settingsCard.style.display === 'block') {
            populateFirebaseConfigInputs();
        }
    } else {
        alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
    }
});

/**
 * Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù‚ÙŠÙ…Ù‡Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
 */
function populateFirebaseConfigInputs() {
    apiKeyInput.value = firebaseConfig.apiKey || '';
    authDomainInput.value = firebaseConfig.authDomain || '';
    databaseURLInput.value = firebaseConfig.databaseURL || '';
    projectIdInput.value = firebaseConfig.projectId || '';
    storageBucketInput.value = firebaseConfig.storageBucket || '';
    messagingSenderIdInput.value = firebaseConfig.messagingSenderId || '';
    appIdInput.value = firebaseConfig.appId || '';
    firebaseConfigMessage.textContent = '';
}

/**
 * Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø²Ø± "Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase".
 */
saveFirebaseConfigBtn.addEventListener('click', () => {
    if (!isAdminUser()) {
        firebaseConfigMessage.textContent = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.';
        firebaseConfigMessage.style.color = 'var(--error-color)';
        return;
    }

    const newConfig = {
        apiKey: apiKeyInput.value.trim(),
        authDomain: authDomainInput.value.trim(),
        databaseURL: databaseURLInput.value.trim(),
        projectId: projectIdInput.value.trim(),
        storageBucket: storageBucketInput.value.trim(),
        messagingSenderId: messagingSenderIdInput.value.trim(),
        appId: appIdInput.value.trim()
    };

    const hasEmptyField = Object.values(newConfig).some(val => val === '');
    if (hasEmptyField) {
        firebaseConfigMessage.style.color = 'var(--error-color)';
        firebaseConfigMessage.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.';
        return;
    }

    saveFirebaseConfigBtn.disabled = true;
    saveFirebaseConfigBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

    try {
        const success = updateFirebaseConfig(newConfig); // Ø¯Ø§Ù„Ø© Ù…Ù† firebase-config.js
        if (success) {
            firebaseConfigMessage.style.color = 'var(--primary-color)';
            firebaseConfigMessage.textContent = 'ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø¨Ù†Ø¬Ø§Ø­! ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.';
        } else {
            firebaseConfigMessage.style.color = 'var(--error-color)';
            firebaseConfigMessage.textContent = 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©.';
        }
    } catch (error) {
        firebaseConfigMessage.style.color = 'var(--error-color)';
        firebaseConfigMessage.textContent = 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ' + error.message;
        console.error("Error saving Firebase config:", error);
    } finally {
        saveFirebaseConfigBtn.disabled = false;
        saveFirebaseConfigBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase';
    }
});


// --- ÙˆØ¸Ø§Ø¦Ù Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ø±Ù (Acquaintances) ---

showAcquaintancesBtn.addEventListener('click', () => showSection('acquaintancesSection'));
refreshAcquaintancesBtn.addEventListener('click', loadAcquaintances);

/**
 * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø±Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ.
 */
function loadAcquaintances() {
    if (!currentUser) {
        acquaintancesList.innerHTML = '<div class="empty">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ø±Ù.</div>';
        acquaintancesCountSpan.textContent = '0';
        return;
    }

    acquaintancesList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ø±Ù...</div>';

    if (unsubscribeAcquaintances) {
        unsubscribeAcquaintances(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚
    }

    unsubscribeAcquaintances = getAcquaintances(currentUser.uid, (acquaintances) => {
        acquaintancesList.innerHTML = '';
        if (acquaintances.length === 0) {
            acquaintancesList.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ù…Ø¹Ø§Ø±Ù Ø¨Ø¹Ø¯.</div>';
            acquaintancesCountSpan.textContent = '0';
            return;
        }

        acquaintancesCountSpan.textContent = acquaintances.length;
        acquaintances.forEach(acquaintance => {
            const acquaintanceItem = document.createElement('div');
            acquaintanceItem.className = 'user-item card'; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            acquaintanceItem.innerHTML = `
                <img src="${acquaintance.profilePictureUrl || defaultAvatarUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø±Ù" class="user-avatar">
                <div class="user-info">
                    <h3>${acquaintance.username}</h3>
                    <!-- Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù‡Ù†Ø§ -->
                </div>
                <button class="secondary-button remove-acquaintance-btn" data-acquaintance-id="${acquaintance.id}">
                    <i class="fas fa-user-minus"></i> Ø¥Ø²Ø§Ù„Ø©
                </button>
            `;
            acquaintancesList.appendChild(acquaintanceItem);

            // Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ø±Ù
            acquaintanceItem.querySelector('.remove-acquaintance-btn').addEventListener('click', async (e) => {
                const targetAcquaintanceId = e.currentTarget.dataset.acquaintanceId;
                const confirmRemoval = confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© ${acquaintance.username} Ù…Ù† Ù…Ø¹Ø§Ø±ÙÙƒØŸ`);
                if (confirmRemoval) {
                    try {
                        await removeAcquaintance(currentUser.uid, targetAcquaintanceId);
                        alert(`ØªÙ… Ø¥Ø²Ø§Ù„Ø© ${acquaintance.username} Ù…Ù† Ù…Ø¹Ø§Ø±ÙÙƒ.`);
                        // loadAcquaintances(); // Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø³ÙŠØ­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§
                    } catch (error) {
                        alert('ÙØ´Ù„ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±Ù: ' + error.message);
                    }
                }
            });
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø±Ù (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙØ§Øª Ø´Ø®ØµÙŠØ© Ø¹Ø§Ù…Ø©)
            acquaintanceItem.addEventListener('click', (e) => {
                // Ù…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø²Ø§Ù„Ø©
                if (!e.target.closest('.remove-acquaintance-btn')) {
                    alert(`Ø³ØªÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø¹Ø±Ù ${acquaintance.username} Ù‡Ù†Ø§. (Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±)`);
                    // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¹Ø§Ù…: Ù…Ø«Ù„Ø§Ù‹ showPublicProfile(acquaintance.id);
                }
            });
        });
    });
}


// --- ÙˆØ¸Ø§Ø¦Ù Ù‚Ø³Ù… Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù† (Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ) ---

/**
 * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§.
 */
function loadOnlineUsers() {
    if (!currentUser) {
        onlineUsersList.innerHTML = '<div class="empty">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†.</div>';
        onlineUsersCountSpan.textContent = '(0)';
        return;
    }

    onlineUsersList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†...</div>';

    if (unsubscribeOnlineUsers) {
        unsubscribeOnlineUsers(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚
    }

    unsubscribeOnlineUsers = getOnlineUsers((users) => {
        onlineUsersList.innerHTML = '';
        // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
        const filteredUsers = users.filter(user => user.id !== currentUser.uid);
        onlineUsersCountSpan.textContent = `(${filteredUsers.length})`;

        if (filteredUsers.length === 0) {
            onlineUsersList.innerHTML = '<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØµÙ„ÙˆÙ† Ø¢Ø®Ø±ÙˆÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§.</div>';
            return;
        }

        filteredUsers.forEach(user => {
            const userItem = document.createElement('li');
            userItem.innerHTML = `
                <span class="status-indicator online"></span>
                <img src="${user.profilePictureUrl || defaultAvatarUrl}" alt="ØµÙˆØ±Ø© ${user.username}" class="online-avatar">
                <span>${user.username}</span>
            `;
            userItem.addEventListener('click', async () => {
                // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØµÙ„ØŒ Ø§ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹Ù‡
                if (currentUser && currentUser.uid !== user.id) {
                    try {
                        const chatId = await createChat([currentUser.uid, user.id]);
                        if (chatId) {
                            openChat(chatId, user.username, user.profilePictureUrl, false, false, user.id);
                            showSection('chatsSection'); // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª ÙˆÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
                        } else {
                            alert('ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.');
                        }
                    } catch (error) {
                        alert('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ' + error.message);
                    }
                }
            });
            onlineUsersList.appendChild(userItem);
        });
    });
}


// --- ÙˆØ¸Ø§Ø¦Ù Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª ---

/**
 * Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.
 */
searchUserBtn.addEventListener('click', async () => {
    const searchTerm = searchUserInput.value.trim();
    if (!searchTerm) {
        searchResultsList.innerHTML = '';
        return;
    }

    searchResultsList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>';
    
    try {
        const users = await searchUsers(searchTerm); // Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø®ÙÙŠ Ù…Ù† firestore.js
        searchResultsList.innerHTML = '';
        
        if (users.length === 0) {
            searchResultsList.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø« Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>';
            return;
        }
        
        users.forEach(user => {
            if (user.id === currentUser.uid) return; // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
            
            const userItem = document.createElement('div');
            userItem.className = 'user-item card';
            userItem.innerHTML = `
                <img src="${user.profilePictureUrl || defaultAvatarUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="user-avatar">
                <div class="user-info">
                    <h3>${user.username}</h3>
                </div>
                <button class="primary-button add-acquaintance-btn" data-user-id="${user.id}">
                    <i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙƒÙ…Ø¹Ø±Ù
                </button>
            `;
            searchResultsList.appendChild(userItem);

            // Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø²Ø± "Ø¥Ø¶Ø§ÙØ© ÙƒÙ…Ø¹Ø±Ù"
            userItem.querySelector('.add-acquaintance-btn').addEventListener('click', async (e) => {
                const userIdToAdd = e.currentTarget.dataset.userId;
                if (currentUser && currentUser.uid !== userIdToAdd) {
                    try {
                        await sendAcquaintanceRequest(currentUser.uid, userIdToAdd);
                        alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${user.username} ÙƒÙ…Ø¹Ø±Ù Ø¨Ù†Ø¬Ø§Ø­!`);
                        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„ÙŠØ¹ÙƒØ³ Ø§Ù„ØªØºÙŠÙŠØ±
                        loadUserProfile(currentUser.uid); 
                        e.currentTarget.disabled = true; // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
                        e.currentTarget.innerHTML = '<i class="fas fa-check"></i> ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©';
                    } catch (error) {
                        alert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±Ù: ' + error.message);
                    }
                } else if (currentUser.uid === userIdToAdd) {
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³Ùƒ ÙƒÙ…Ø¹Ø±Ù.');
                } else {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ø±Ù.');
                }
            });

            // Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© (Ù…Ø§ Ø¹Ø¯Ø§ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
            userItem.addEventListener('click', async (e) => {
                // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù†Ù‚Ø± Ù„Ù… ÙŠÙƒÙ† Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                if (e.target.closest('.add-acquaintance-btn')) return;

                if (!currentUser) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©.');
                    return;
                }
                if (currentUser.uid === user.id) {
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ù†ÙØ³Ùƒ.');
                    return;
                }
                // Ù…Ø³Ø­ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù…
                searchResultsList.innerHTML = '';
                searchUserInput.value = '';

                try {
                    const chatId = await createChat([currentUser.uid, user.id]);
                    if (chatId) {
                        openChat(chatId, user.username || user.email.split('@')[0], user.profilePictureUrl, false, false, user.id);
                    } else {
                        alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡/ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.');
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ' + error.message);
                }
            });
        });
    } catch (error) {
        console.error("Search users error:", error);
        searchResultsList.innerHTML = `<div class="error-message">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«: ${error.message}</div>`;
    }
});

/**
 * ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ´Ø§Ø±Ùƒ ÙÙŠÙ‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 */
async function loadChats() {
    if (!currentUser) {
        chatsList.innerHTML = '<div class="empty">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª.</div>';
        return;
    }

    chatsList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª...</div>';

    getParticipatingChats(currentUser.uid, async (chats) => {
        chatsList.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

        if (chats.length === 0) {
            chatsList.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¯Ø´Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§. Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©!</div>';
            return;
        }

        const chatItemsPromises = chats.map(async chatDoc => {
            const chat = chatDoc;
            const chatId = chat.id;

            let chatName = chat.name || 'Ù…Ø­Ø§Ø¯Ø«Ø© ÙØ±Ø¯ÙŠØ©';
            let chatAvatar = defaultAvatarUrl;
            let isGroup = chat.isGroup || false; // Ø§Ø³ØªØ®Ø¯Ø§Ù… isGroup Ù…Ù† Firestore
            let isNewsChannel = chat.newsChannel || false;
            let otherParticipantId = null;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ø®Ø§ØµØ©
            if (chat.publicChat) {
                chatName = 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©';
                chatAvatar = 'https://via.placeholder.com/50/800080/FFFFFF?text=GC'; // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
            } else if (chat.newsChannel) {
                chatName = 'Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø±';
                chatAvatar = 'https://via.placeholder.com/50/FFD700/000000?text=NEWS'; // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
            } else if (chat.publicGroup) {
                 chatName = 'Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©';
                 chatAvatar = 'https://via.placeholder.com/50/008080/FFFFFF?text=ALL'; // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
            }
             else if (!isGroup) {
                // Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©ØŒ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¢Ø®Ø±
                const otherParticipantsIds = Object.keys(chat.participants).filter(uid => uid !== currentUser.uid);
                if (otherParticipantsIds.length > 0) {
                    otherParticipantId = otherParticipantsIds[0];
                    try {
                        const otherUserDoc = await getUserProfile(otherParticipantId);
                        if (otherUserDoc.exists) {
                            const otherUser = otherUserDoc.data();
                            chatName = otherUser.username || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                            chatAvatar = otherUser.profilePictureUrl || defaultAvatarUrl;
                        } else {
                            chatName = 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                            chatAvatar = defaultAvatarUrl;
                        }
                    } catch (e) {
                        console.error("Error fetching other user profile:", e);
                        chatName = 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ (Ø®Ø·Ø£)';
                        chatAvatar = defaultAvatarUrl;
                    }
                }
            }

            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            if (chatId === currentChatId) {
                chatItem.classList.add('active'); // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù†Ø´Ø·Ø©
            }
            chatItem.setAttribute('data-chat-id', chatId);

            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
            const unreadCount = 0; // ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¬Ù„Ø¨ Ù‡Ø°Ø§ Ù…Ù† Firestore
            const unreadBadge = unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : '';

            chatItem.innerHTML = `
                <img src="${chatAvatar}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©" class="chat-avatar">
                <div class="chat-item-content">
                    <h3>${chatName}</h3>
                    <p class="last-message">${chat.lastMessage || 'Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰!'}</p>
                </div>
                <span class="time">${formatTime(chat.lastMessageAt)}</span>
                ${unreadBadge}
            `;

            chatItem.addEventListener('click', () => {
                openChat(chatId, chatName, chatAvatar, isGroup, isNewsChannel, otherParticipantId);
            });
            return chatItem;
        });

        const chatItems = await Promise.all(chatItemsPromises);
        chatItems.forEach(item => chatsList.appendChild(item));

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ØªØ¸Ù„ Ù…Ù…ÙŠØ²Ø© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        if (currentChatId) {
            const activeChatItem = chatsList.querySelector(`[data-chat-id="${currentChatId}"]`);
            if (activeChatItem) {
                activeChatItem.classList.add('active');
            }
        }
    });
}

/**
 * ÙØªØ­ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ÙŠÙ†Ø© ÙˆØ¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„Ù‡Ø§.
 * @param {string} chatId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 * @param {string} chatName - Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 * @param {string} chatAvatar - Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 * @param {boolean} isGroupChat - Ù‡Ù„ Ù‡ÙŠ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©ØŸ
 * @param {boolean} isNewsChannel - Ù‡Ù„ Ù‡ÙŠ Ù‚Ù†Ø§Ø© Ø£Ø®Ø¨Ø§Ø± (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)ØŸ
 * @param {string} [otherId=null] - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¢Ø®Ø± ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©.
 */
function openChat(chatId, chatName, chatAvatar, isGroupChat, isNewsChannel = false, otherId = null) {
    currentChatId = chatId;
    currentChatName = chatName;
    currentChatAvatar = chatAvatar;
    isCurrentChatGroup = isGroupChat;
    isCurrentChatNewsChannel = isNewsChannel;
    currentOtherParticipantId = otherId;

    chatHeaderName.textContent = chatName;
    chatHeaderAvatar.src = chatAvatar;
    chatContainer.classList.add('active'); // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    chatsSection.classList.remove('active'); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„

    // Ø¥Ø²Ø§Ù„Ø© ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ¥Ø¶Ø§ÙØ© ØªÙ…ÙŠÙŠØ² Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
    const activeChatItem = chatsList.querySelector(`[data-chat-id="${chatId}"]`);
    if (activeChatItem) {
        activeChatItem.classList.add('active');
    }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù…Ø±Ø¨Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù‚Ù†Ø§Ø© Ø£Ø®Ø¨Ø§Ø± Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)
    if (isNewsChannel && !isAdminUser()) { // ÙÙ‚Ø· Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
        messageInputForm.style.display = 'none';
    } else {
        messageInputForm.style.display = 'flex';
    }

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (unsubscribeChatStatus) {
        unsubscribeChatStatus();
    }
    if (unsubscribeTypingStatus) {
        unsubscribeTypingStatus();
    }
    chatStatus.textContent = ''; // Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø± (Ù…ØªØµÙ„/Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±) ÙˆØ­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©
    if (!isGroupChat && otherId) {
        unsubscribeChatStatus = listenToUserStatus(otherId, (userData) => {
            if (userData.isOnline) {
                chatStatus.textContent = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
                chatStatus.style.color = 'var(--online-indicator-color)';
            } else {
                chatStatus.textContent = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${formatPreciseTime(userData.lastSeen)}`;
                chatStatus.style.color = 'var(--text-light-color)';
            }
        });
        unsubscribeTypingStatus = listenToTypingStatus(chatId, otherId, (isTyping) => {
            if (isTyping) {
                chatStatus.textContent = 'ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...';
                chatStatus.style.color = 'var(--primary-color)'; // Ù„ÙˆÙ† Ù…Ù…ÙŠØ² Ù„Ù„ÙƒØªØ§Ø¨Ø©
            } else if (chatStatus.textContent === 'ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...') {
                // Ø¥Ø°Ø§ ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø©ØŒ Ø£Ø¹Ø¯ Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ©
                if (unsubscribeChatStatus) { // Ø£Ø¹Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ù„ÙŠØ¹ÙˆØ¯ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
                    unsubscribeChatStatus();
                }
                unsubscribeChatStatus = listenToUserStatus(otherId, (userData) => {
                    if (userData.isOnline) {
                        chatStatus.textContent = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
                        chatStatus.style.color = 'var(--online-indicator-color)';
                    } else {
                        chatStatus.textContent = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${formatPreciseTime(userData.lastSeen)}`;
                        chatStatus.style.color = 'var(--text-light-color)';
                    }
                });
            }
        });
    }

    loadMessages(chatId); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©
}

/**
 * Ø¥ØºÙ„Ø§Ù‚ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª.
 */
function closeChat() {
    chatContainer.classList.remove('active');
    chatsSection.classList.add('active'); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
    
    // Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
    }
    if (unsubscribeChatStatus) {
        unsubscribeChatStatus();
        unsubscribeChatStatus = null;
    }
    if (unsubscribeTypingStatus) {
        unsubscribeTypingStatus();
        unsubscribeTypingStatus = null;
    }
    
    messagesList.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    chatStatus.textContent = '';
    currentChatId = null; // Ù…Ø³Ø­ Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ
    currentChatName = null;
    currentChatAvatar = null;
    isCurrentChatGroup = false;
    isCurrentChatNewsChannel = false;
    currentOtherParticipantId = null;
}

closeChatBtn.addEventListener('click', closeChat);

/**
 * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.
 * @param {Array<Object>} messages - Ù…ØµÙÙˆÙØ© Ù…Ù† ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.
 */
function displayMessages(messages) {
    messagesList.innerHTML = '';
    const messagesToMarkAsRead = [];
    let firstUnreadMessageId = null; // Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† ÙØ§ØµÙ„ "Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©"

    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ØªØ±ØªÙŠØ¨ Ø²Ù…Ù†ÙŠ ØµØ­ÙŠØ­ (Ø§Ù„Ø£Ù‚Ø¯Ù… ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ØŒ Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„)
    // Firestore ÙŠØ±Ø¬Ø¹Ù‡Ø§ Ù‡Ù†Ø§ descendingØŒ Ù„Ø°Ø§ ÙŠØ¬Ø¨ Ø¹ÙƒØ³Ù‡Ø§ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… flex-direction: column-reverse
    // Ù„Ù‚Ø¯ Ù‚Ù…Ù†Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨ØªØ¹ÙŠÙŠÙ† flex-direction: column-reverse ÙÙŠ CSSØŒ Ù„Ø°Ø§ Ù†Ø¶ÙŠÙÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©.

    messages.forEach(message => {
        const messageItem = document.createElement('div');
        const isSentByCurrentUser = message.senderId === currentUser.uid;
        messageItem.className = `message-item ${isSentByCurrentUser ? 'sent' : 'received'}`;
        messageItem.setAttribute('data-message-id', message.id);

        const senderUsername = message.senderUsername || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ù‚Ù„ userProfilePic ÙÙŠ ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ù„Ø°Ø§ Ù†Ø³ØªØ®Ø¯Ù… defaultAvatarUrl
        const senderProfilePic = defaultAvatarUrl;

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ù„ØªÙ…ÙŠÙŠØ²Ù‡Ø§ (Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ÙÙ‚Ø·)
        if (!isSentByCurrentUser && !(message.readBy && message.readBy[currentUser.uid])) {
            messagesToMarkAsRead.push(message.id);
            if (!firstUnreadMessageId) {
                firstUnreadMessageId = message.id; // Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©
            }
        }

        // Ø¹Ø±Ø¶ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØµØ­ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© (ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ / ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©)
        let readStatusHtml = '';
        if (isSentByCurrentUser) {
            // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¢Ø®Ø±ÙˆÙ† ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
            const otherParticipantsIds = Object.keys(currentChatId === PUBLIC_GROUP_CHAT_ID ? {} : (isCurrentChatGroup ? {} : chatHeaderName.dataset.participants || {})).filter(id => id !== currentUser.uid);
            
            // Ø¨Ø¨Ø³Ø§Ø·Ø©ØŒ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© ÙˆÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ø±Ù Ø¢Ø®Ø± ÙˆÙ‚Ø±Ø£ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            const otherUserRead = (message.readBy && currentOtherParticipantId && message.readBy[currentOtherParticipantId]);
            
            // ØªØ­Ù‚Ù‚ Ù…Ø²Ø¯ÙˆØ¬ (âœ“âœ“) Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
            readStatusHtml = `
                <div class="message-status">
                    <span class="check-icon fas fa-check ${otherUserRead ? 'read' : ''}"></span>
                    <span class="check-icon fas fa-check ${otherUserRead ? 'read' : ''}"></span>
                </div>
            `;
        }

        messageItem.innerHTML = `
            <img src="${senderProfilePic}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø³Ù„" class="message-avatar">
            <div class="message-content">
                ${!isSentByCurrentUser ? `<div class="message-sender">${senderUsername}</div>` : ''}
                <p>${message.content}</p>
                <div class="message-time">${formatTime(message.timestamp)}</div>
                ${readStatusHtml}
            </div>
        `;
        messagesList.appendChild(messageItem);
    });

    // Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„ "Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©" Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©
    if (firstUnreadMessageId) {
        const firstUnreadElement = messagesList.querySelector(`[data-message-id="${firstUnreadMessageId}"]`);
        if (firstUnreadElement) {
            const unreadDivider = document.createElement('div');
            unreadDivider.className = 'unread-divider';
            unreadDivider.textContent = 'Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©';
            messagesList.insertBefore(unreadDivider, firstUnreadElement);
        }
    }

    // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø© ÙÙŠ Firestore Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶Ù‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (messagesToMarkAsRead.length > 0 && currentUser) {
        markMessagesAsRead(currentChatId, messagesToMarkAsRead, currentUser.uid);
    }

    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„ Ù„Ø¹Ø±Ø¶ Ø£Ø­Ø¯Ø« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    messagesList.scrollTop = messagesList.scrollHeight;
}

/**
 * ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ÙŠÙ†Ø©.
 * @param {string} chatId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 */
function loadMessages(chatId) {
    if (unsubscribeMessages) {
        unsubscribeMessages(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    }
    messagesList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>';
    unsubscribeMessages = getMessages(chatId, displayMessages); // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
}

/**
 * Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.
 */
messageInputForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = messageInput.value.trim();
    if (!content || !currentChatId || !currentUser) return; // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…

    sendMessageBtn.disabled = true;
    sendMessageBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
    
    try {
        const senderUsername = currentUserProfileData.username; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        const success = await sendMessage(currentChatId, currentUser.uid, senderUsername, content);
        if (success) {
            messageInput.value = ''; // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            messageInput.style.height = 'auto'; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø±ØªÙØ§Ø¹ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            await updateTypingStatus(currentChatId, currentUser.uid, false); // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
        }
    } catch (error) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + error.message);
    } finally {
        sendMessageBtn.disabled = false;
        sendMessageBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„';
    }
});

// Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
messageInput.addEventListener('input', async () => {
    messageInput.style.height = 'auto'; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ­ÙŠØ­
    messageInput.style.height = messageInput.scrollHeight + 'px'; // Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (currentUser && currentChatId) {
        await updateTypingStatus(currentChatId, currentUser.uid, true);
        clearTimeout(typingTimer); // Ù…Ø³Ø­ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø³Ø§Ø¨Ù‚
        typingTimer = setTimeout(async () => {
            await updateTypingStatus(currentChatId, currentUser.uid, false); // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø©
        }, TYPING_TIMEOUT);
    }
});

// Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ© (Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±)
recordAudioBtn.addEventListener('click', () => {
    alert("ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ© ØºÙŠØ± Ù…Ø·Ø¨Ù‚Ø© Ø¨Ø¹Ø¯. ØªØªØ·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª.");
});

// Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
emojiPickerBtn.addEventListener('click', () => {
    emojiPicker.classList.toggle('active'); // ØªØ¨Ø¯ÙŠÙ„ Ø±Ø¤ÙŠØ© Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    if (emojiPicker.classList.contains('active')) {
        // Ø¨Ù†Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹Ù‡Ø§ Ù„ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)
        emojiPicker.innerHTML = `
            <span class="emoji-item">ğŸ˜€</span>
            <span class="emoji-item">ğŸ‘‹</span>
            <span class="emoji-item">ğŸ‘</span>
            <span class="emoji-item">â¤ï¸</span>
            <span class="emoji-item">ğŸ˜‚</span>
            <span class="emoji-item">ğŸ¤”</span>
            <span class="emoji-item">ğŸ‰</span>
            <span class="emoji-item">ğŸ‘</span>
            <span class="emoji-item">ğŸ˜</span>
            <span class="emoji-item">ğŸ¤©</span>
            <span class="emoji-item">ğŸ˜­</span>
            <span class="emoji-item">ğŸ˜¤</span>
            <span class="emoji-item">ğŸ˜¡</span>
            <span class="emoji-item">ğŸ¥º</span>
            <span class="emoji-item">ğŸ¤¯</span>
            <span class="emoji-item">ğŸ˜´</span>
        `;
        emojiPicker.querySelectorAll('.emoji-item').forEach(span => {
            span.addEventListener('click', () => {
                messageInput.value += span.textContent; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¥Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                messageInput.focus();
                messageInput.style.height = 'auto'; // Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                messageInput.style.height = messageInput.scrollHeight + 'px';
                emojiPicker.classList.remove('active'); // Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
            });
        });
    }
});

// Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', (e) => {
    if (!emojiPicker.contains(e.target) && e.target !== emojiPickerBtn && emojiPicker.classList.contains('active')) {
        emojiPicker.classList.remove('active');
    }
});


// --- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ---
showPostsBtn.addEventListener('click', () => showSection('postsSection'));
showChatsBtn.addEventListener('click', () => showSection('chatsSection'));
showAcquaintancesBtn.addEventListener('click', () => showSection('acquaintancesSection'));
showProfileBtn.addEventListener('click', () => showSection('profileSection'));


// --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ DOM Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªÙ‡ÙŠØ¦Ø© Ø¨Ø¹Ø¶ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù.
document.addEventListener('DOMContentLoaded', () => {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡ Ø¥Ù„Ù‰ "Ù…ØªØµÙ„" ÙˆØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
    if (auth.currentUser) {
        updateUserStatus(auth.currentUser.uid, true);
        loadOnlineUsers();
    }
});

// Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ "ØºÙŠØ± Ù…ØªØµÙ„"
// (ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‡Ø°Ø§ ÙÙŠ auth.js Ø¨ÙˆØ§Ø³Ø·Ø© addEventListener('beforeunload'))




// public/auth.js

// Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
const authScreen = document.getElementById('authScreen');
const authEmail = document.getElementById('authEmail');
const authPassword = document.getElementById('authPassword');
const authSubmitBtn = document.getElementById('authSubmitBtn'); // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
const authError = document.getElementById('authError');
const toggleAuthMode = document.getElementById('toggleAuthMode'); // Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªØ³Ø¬ÙŠÙ„

const mainApp = document.getElementById('mainApp');
const logoutBtn = document.getElementById('logoutBtn');
const loadingScreen = document.getElementById('loadingScreen');

// Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ Ù…Ù† Firestore
let currentUser = null; // ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase Authentication
let currentUserProfileData = null; // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª)

// Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†
// Ù‡Ø¤Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø³ÙŠØ­ØµÙ„ÙˆÙ† Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø®Ø§ØµØ© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.
const ADMIN_EMAILS = ["sesef42331@gmail.com", "sese42331@gmail.com"]; // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø¨Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø§Ù„ÙØ¹Ù„ÙŠÙŠÙ† Ù„Ø¯ÙŠÙƒ

let isLoginMode = true; // Ù„ØªØªØ¨Ø¹ Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨

/**
 * ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© ØªÙØ³ØªØ¯Ø¹Ù‰ ÙƒÙ„Ù…Ø§ ØªØºÙŠØ±Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬).
 * @param {firebase.User} user - ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Firebase AuthenticationØŒ Ø£Ùˆ null Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.
 */
async function updateAuthUI(user) {
    if (user) {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        currentUser = user; // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ

        try {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore
            const profileDoc = await getUserProfile(user.uid);

            if (profileDoc.exists) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù„Ù Ø§Ù„ØªØ¹Ø±ÙŠÙ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
                currentUserProfileData = profileDoc.data();
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ (Ù‚Ø¯ ÙŠØ­Ø¯Ø« Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¬Ø¯Ø¯ Ø£Ùˆ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ù… Ø®Ø§Ø±Ø¬ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)ØŒ
                // Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
                // ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙƒÙ€ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù‚Ø¨Ù„ @
                await createUserProfile(user.uid, user.email, user.email.split('@')[0]);
                const newProfileDoc = await getUserProfile(user.uid); // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
                currentUserProfileData = newProfileDoc.data();
            }

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ "Ù…ØªØµÙ„" ÙÙŠ Firestore
            await updateUserStatus(user.uid, true);

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
            authScreen.classList.remove('active');
            mainApp.classList.add('active');

            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­
            // Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙŠØªÙ… ØªØ¹Ø±ÙŠÙÙ‡Ø§ ÙÙŠ app.js ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† firestore.js
            loadUserProfile(user.uid); // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            loadPosts();              // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
            loadChats();              // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
            loadOnlineUsers();        // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø­Ø¯Ø« Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ "ØºÙŠØ± Ù…ØªØµÙ„"
            window.removeEventListener('beforeunload', handleBeforeUnload); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
            window.addEventListener('beforeunload', handleBeforeUnload);

        } catch (error) {
            // ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©ØŒ
            // Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù…Ù†Ø¹ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆÙ„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
            console.error("Error loading user profile or updating status:", error);
            await auth.signOut(); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… alert() Ù‡Ù†Ø§ Ù„Ø£Ù†Ù†Ø§ ÙÙŠ Ø³ÙŠØ§Ù‚ ØªØ­Ø¯ÙŠØ« UI ØªÙ„Ù‚Ø§Ø¦ÙŠ
        }

    } else {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø£Ùˆ Ù‚Ø§Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬)
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø§Ø¨Ù‚ Ù‚Ø§Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡ Ø¥Ù„Ù‰ "ØºÙŠØ± Ù…ØªØµÙ„"
        if (currentUser && currentUser.uid) {
            await updateUserStatus(currentUser.uid, false);
        }
        currentUser = null;
        currentUserProfileData = null; // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠØ©

        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        authScreen.classList.add('active');
        mainApp.classList.remove('active');
    }
    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù…Ø¬Ø±Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    loadingScreen.classList.remove('active');
}

/**
 * Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« 'beforeunload' Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ØºÙŠØ± Ù…ØªØµÙ„.
 * ÙŠØªÙ… ÙØµÙ„Ù‡Ø§ ÙƒØ¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¥Ø²Ø§Ù„Ø© ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ©.
 */
async function handleBeforeUnload() {
    if (currentUser) {
        await updateUserStatus(currentUser.uid, false);
    }
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙÙŠ Firebase
// ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© updateAuthUI() ÙƒÙ„Ù…Ø§ ØªØºÙŠØ±Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
auth.onAuthStateChanged(updateAuthUI);

/**
 * Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.
 * ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© isLoginMode.
 */
authSubmitBtn.addEventListener('click', async (e) => {
    e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø²Ø± (Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬)
    const email = authEmail.value.trim();
    const password = authPassword.value.trim();
    authError.textContent = ''; // Ù…Ø³Ø­ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    if (!email || !password) {
        authError.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.';
        return;
    }
    if (password.length < 6) {
        authError.textContent = 'ÙŠØ¬Ø¨ Ø£Ù† ØªØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
        return;
    }

    authSubmitBtn.disabled = true; // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
    const originalBtnText = authSubmitBtn.textContent;
    authSubmitBtn.textContent = isLoginMode ? 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...' : 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';

    try {
        if (isLoginMode) {
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            await auth.signInWithEmailAndPassword(email, password);
        } else {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const userId = userCredential.user.uid;
            // Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙÙ‡ ÙÙŠ Firestore ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
            await createUserProfile(userId, email, email.split('@')[0]);
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
            // Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            toggleAuthForm(true);
        }
    } catch (error) {
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£: ';
        if (error.code === 'auth/user-not-found') {
            errorMessage += 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.';
        } else if (error.code === 'auth/wrong-password') {
            errorMessage += 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©.';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage += 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
        } else if (error.code === 'auth/email-already-in-use') {
            errorMessage += 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.';
        } else if (error.code === 'auth/weak-password') {
            errorMessage += 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ù‹Ø§ (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).';
        } else {
            errorMessage += error.message;
        }
        authError.textContent = errorMessage;
        console.error("Authentication Error:", error);
    } finally {
        authSubmitBtn.disabled = false; // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        authSubmitBtn.textContent = originalBtnText; // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
    }
});

/**
 * Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙˆØ¶Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.
 * @param {boolean} [setToLogin=null] - Ø¥Ø°Ø§ ÙƒØ§Ù† trueØŒ ÙŠØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.
 * Ø¥Ø°Ø§ ÙƒØ§Ù† falseØŒ ÙŠØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„ÙˆØ¶Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.
 * Ø¥Ø°Ø§ ÙƒØ§Ù† nullØŒ ÙŠØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†.
 */
toggleAuthMode.addEventListener('click', (e) => {
    e.preventDefault();
    toggleAuthForm();
});

function toggleAuthForm(setToLogin = null) {
    if (setToLogin !== null) {
        isLoginMode = setToLogin;
    } else {
        isLoginMode = !isLoginMode;
    }

    if (isLoginMode) {
        authSubmitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        toggleAuthMode.textContent = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
    } else {
        authSubmitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
        toggleAuthMode.textContent = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    }
    authError.textContent = ''; // Ù…Ø³Ø­ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
document.addEventListener('DOMContentLoaded', () => {
    toggleAuthForm(true); // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
});


/**
 * Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.
 */
logoutBtn.addEventListener('click', async () => {
    try {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ "ØºÙŠØ± Ù…ØªØµÙ„" ÙÙŠ Firestore Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        if (currentUser) {
            await updateUserStatus(currentUser.uid, false);
        }
        await auth.signOut(); // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase
        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (error) {
        console.error("Logout Error:", error);
        alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + error.message);
    }
});

/**
 * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹.
 * @returns {boolean} - True Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹ØŒ False Ø¨Ø®Ù„Ø§Ù Ø°Ù„Ùƒ.
 */
function isAdminUser() {
    return currentUser && ADMIN_EMAILS.includes(currentUser.email);
}





// public/firebase-config.js

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ
// Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¶Ø±ÙˆØ±ÙŠØ© Ù„ØªÙ‡ÙŠØ¦Ø© Ø§ØªØµØ§Ù„ ØªØ·Ø¨ÙŠÙ‚Ùƒ Ø¨Ù€ Firebase.
// ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙŠ Ø²ÙˆØ¯ØªÙ†ÙŠ Ø¨Ù‡Ø§ Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø§ØªØµØ§Ù„.
const initialFirebaseConfig = {
    apiKey: "AIzaSyAguAvkgdnbtkIsdBjR0Av0ikUOCbqc8lI",
    authDomain: "chat-ttt-2023e.firebaseapp.com",
    databaseURL: "https://chat-ttt-2023e-default-rtdb.firebaseio.com",
    projectId: "chat-ttt-2023e",
    storageBucket: "chat-ttt-2023e.firebasestorage.app", // ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø£Ø®ÙŠØ±
    messagingSenderId: "89047633906",
    appId: "1:89047633906:web:1358af9c956746a120e56b"
};

// Ù…ØªØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø³ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ù†Ø´Ø·Ø©
let firebaseConfig = { ...initialFirebaseConfig };

// Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Local Storage)
// Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­ÙØ¸Ù‡Ø§.
try {
    const storedConfig = localStorage.getItem('firebaseAppConfig');
    if (storedConfig) {
        const parsedConfig = JSON.parse(storedConfig);
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© ØµØ§Ù„Ø­Ø© ÙˆØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ API Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
        if (parsedConfig && typeof parsedConfig === 'object' && parsedConfig.apiKey) {
            firebaseConfig = parsedConfig;
        }
    }
} catch (e) {
    // ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    console.error("Error loading Firebase config from Local Storage:", e);
}

// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ø®Ø¯Ù…Ø§Øª Firebase Ù„ÙŠØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
let app;
let auth;
let db;

/**
 * ØªÙ‡ÙŠØ¦Ø© ØªØ·Ø¨ÙŠÙ‚ Firebase.
 * ØªØ¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø£Ù† Firebase ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ
 * ÙˆØªÙ‚ÙˆÙ… Ø¨ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª auth Ùˆ db Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ù‡Ù„.
 */
function initializeFirebaseApp() {
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£ÙŠ ØªØ·Ø¨ÙŠÙ‚ Firebase Ù…Ù‡ÙŠØ£ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù‚Ù… Ø¨ØªÙ‡ÙŠØ¦ØªÙ‡
    if (firebase.apps.length === 0) {
        app = firebase.initializeApp(firebaseConfig);
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ·Ø¨ÙŠÙ‚ Ù…Ù‡ÙŠØ£ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        app = firebase.app();
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø«ÙŠÙ„Ø§Øª Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ùˆ Firestore
    auth = firebase.auth(app); // Ø§Ø³ØªØ®Ø¯Ø§Ù… app Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­
    db = firebase.firestore(app); // Ø§Ø³ØªØ®Ø¯Ø§Ù… app Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­

    // ØªÙ…ÙƒÙŠÙ† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Firestore ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ (Offline Persistence)
    // Ù‡Ø°Ø§ ÙŠØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø­ØªÙ‰ Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§).
    db.enablePersistence()
      .catch((err) => {
          // ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ©
          // (Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø¨Ø³Ø¨Ø¨ ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¨ÙˆÙŠØ¨ Ù…ØªØ¹Ø¯Ø¯Ø© Ù…ÙØªÙˆØ­Ø©)
          console.warn('Firestore persistence not enabled: ', err);
      });
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
initializeFirebaseApp();

/**
 * ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.
 * @param {object} newConfig - ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.
 * @returns {boolean} - True Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ØŒ False Ø¨Ø®Ù„Ø§Ù Ø°Ù„Ùƒ.
 */
function updateFirebaseConfig(newConfig) {
    // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØºÙŠØ± ÙØ§Ø±ØºØ©
    const requiredKeys = ['apiKey', 'authDomain', 'projectId', 'appId']; // ØªÙ… Ø­Ø°Ù storageBucket Ùˆ messagingSenderId Ù„Ø£Ù†Ù‡Ø§ Ù„ÙŠØ³Øª Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø©

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ¹Ø¯Ù… ÙØ±Ø§ØºÙ‡Ø§
    for (const key of requiredKeys) {
        if (!newConfig[key] || newConfig[key].trim() === '') {
            console.error(`Missing or empty required Firebase config key: ${key}`);
            return false;
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ù†Ø´Ø·Ø©
    firebaseConfig = { ...newConfig };
    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    localStorage.setItem('firebaseAppConfig', JSON.stringify(firebaseConfig));
    console.warn("Firebase config updated. Please refresh the page for changes to take effect.");
    return true;
}




// public/firestore.js

// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ø®Ø¯Ù…Ø§Øª Firebase (ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ ÙÙŠ firebase-config.js)
// ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ firebase-config.js
// Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ "ØºÙŠØ± Ù…Ø¹Ø±Ù"
// const auth = firebase.auth(); // Ù‡Ø°Ø§ Ù„Ù… ÙŠØ¹Ø¯ Ø¶Ø±ÙˆØ±ÙŠØ§ Ù‡Ù†Ø§ØŒ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡ Ø¹Ø§Ù„Ù…ÙŠØ§
// const db = firebase.firestore(); // Ù‡Ø°Ø§ Ù„Ù… ÙŠØ¹Ø¯ Ø¶Ø±ÙˆØ±ÙŠØ§ Ù‡Ù†Ø§ØŒ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡ Ø¹Ø§Ù„Ù…ÙŠØ§

// Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
const defaultAvatarUrl = "https://via.placeholder.com/150/CCCCCC/000000?text=AV"; // Placeholder Avatar
const PUBLIC_CHAT_ID = "general_public_chat"; // Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙÙŠÙ‡Ø§)
const NEWS_CHANNEL_ID = "news_announcements_channel"; // Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)
const PUBLIC_GROUP_CHAT_ID = "all_users_group_chat"; // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ---

/**
 * ÙŠÙ†Ø´Ø¦ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firestore.
 * ÙŠØ¶Ù…Ù† Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙØ±ÙŠØ¯ ÙˆÙŠØ¶ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UID).
 * @param {string} email - Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} defaultUsername - Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ (Ø¹Ø§Ø¯Ø© Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ).
 */
async function createUserProfile(userId, email, defaultUsername) {
    const userRef = db.collection('users').doc(userId);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
        let username = defaultUsername;
        let counter = 0;
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ±ÙŠØ¯
        while (await checkUsernameExists(username)) {
            username = `${defaultUsername}_${++counter}`;
        }

        await userRef.set({
            email: email,
            username: username,
            profilePictureUrl: defaultAvatarUrl,
            postsCount: 0,
            // Ø§Ù„Ù…Ø¹Ø§Ø±Ù (Acquaintances) - ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙƒØ®Ø±ÙŠØ·Ø© Ù„Ø³Ù‡ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ù…ØªØ¨Ø§Ø¯Ù„Ø©
            acquaintances: {}, 
            isProfilePrivate: false, // Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            statusMessage: 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø£Ø³ØªØ®Ø¯Ù… ØªÙˆØ§ØµÙ„.', // Ø­Ø§Ù„Ø© Ù…Ø²Ø§Ø¬ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            savedPosts: {}, // Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (ÙƒØ®Ø±ÙŠØ·Ø© postId -> timestamp)
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
            isOnline: true // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ…ØªØµÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
        });

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
        await addParticipantToChat(PUBLIC_CHAT_ID, userId, username);
        await addParticipantToChat(NEWS_CHANNEL_ID, userId, username);
        await addParticipantToChat(PUBLIC_GROUP_CHAT_ID, userId, username);

        console.log(`User profile for ${username} created and added to public chats.`);
    } else {
        console.log("User profile already exists. Updating status and ensuring public chat membership.");
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù‚Ù… ÙÙ‚Ø· Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¶ÙˆÙŠØªÙ‡ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        await updateUserStatus(userId, true);
        const existingUserData = userDoc.data();
        await addParticipantToChat(PUBLIC_CHAT_ID, userId, existingUserData.username || email.split('@')[0]);
        await addParticipantToChat(NEWS_CHANNEL_ID, userId, existingUserData.username || email.split('@')[0]);
        await addParticipantToChat(PUBLIC_GROUP_CHAT_ID, userId, existingUserData.username || email.split('@')[0]);
    }
}

/**
 * ÙŠØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Firestore.
 * @param {string} username - Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ­Ù‚Ù‚.
 * @returns {Promise<boolean>} - True Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ False Ø¨Ø®Ù„Ø§Ù Ø°Ù„Ùƒ.
 */
async function checkUsernameExists(username) {
    const snapshot = await db.collection('users')
        .where('username', '==', username)
        .limit(1)
        .get();
    return !snapshot.empty;
}

/**
 * ÙŠØ­Ø¯Ù‘Ø« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {boolean} isOnline - True Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØµÙ„Ø§Ù‹ØŒ False Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…ØªØµÙ„.
 */
async function updateUserStatus(userId, isOnline) {
    try {
        const userRef = db.collection('users').doc(userId);
        await userRef.update({
            isOnline: isOnline,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error("Error updating user status:", error);
    }
}

/**
 * ÙŠØ³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ÙŠÙ† ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„ØªÙ‡.
 * @param {function} callback - Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (isOnline, lastSeen).
 * @returns {function} - Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹.
 */
function listenToUserStatus(userId, callback) {
    return db.collection('users').doc(userId).onSnapshot(doc => {
        if (doc.exists) {
            const data = doc.data();
            callback({
                isOnline: data.isOnline,
                lastSeen: data.lastSeen
            });
        }
    });
}

/**
 * ÙŠØ¬Ù„Ø¨ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø­Ø¯.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @returns {Promise<DocumentSnapshot>} - ÙˆØ¹Ø¯ Ø¨ÙƒØ§Ø¦Ù† DocumentSnapshot.
 */
function getUserProfile(userId) {
    return db.collection('users').doc(userId).get();
}

/**
 * ÙŠØ¬Ù„Ø¨ Ù…Ù„ÙØ§Øª ØªØ¹Ø±ÙŠÙ Ù„Ø¹Ø¯Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.
 * ÙŠØ³ØªØ®Ø¯Ù… Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø¥Ù„Ù‰ Ø¯ÙØ¹Ø§Øª (chunks) Ù„ØªØ¬Ø§ÙˆØ² Ø­Ø¯ 10 ÙÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª 'in'.
 * @param {string[]} userIds - Ù…ØµÙÙˆÙØ© Ù…Ù† Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.
 * @returns {Promise<Object[]>} - ÙˆØ¹Ø¯ Ø¨Ù…ØµÙÙˆÙØ© Ù…Ù† ÙƒØ§Ø¦Ù†Ø§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 */
async function getUsersProfiles(userIds) {
    if (userIds.length === 0) return [];

    const chunks = [];
    for (let i = 0; i < userIds.length; i += 10) {
        chunks.push(userIds.slice(i, i + 10));
    }

    let allUsers = [];
    for (const chunk of chunks) {
        const snapshots = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get();
        snapshots.forEach(doc => allUsers.push({ id: doc.id, ...doc.data() }));
    }
    return allUsers;
}

/**
 * ÙŠØ­Ø¯Ù‘Ø« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙØ±Ø¯.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} newUsername - Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯.
 * @returns {Promise<boolean>} - True Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ«.
 */
async function updateUsername(userId, newUsername) {
    const userRef = db.collection('users').doc(userId);
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ±ÙŠØ¯ (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡)
    const existingUsers = await db.collection('users').where('username', '==', newUsername).get();
    if (!existingUsers.empty && existingUsers.docs[0].id !== userId) {
        throw new Error("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…Ø­Ø¬ÙˆØ² Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±.");
    }

    try {
        await userRef.update({ username: newUsername });
        console.log("Username updated successfully.");
        return true;
    } catch (error) {
        console.error("Error updating username:", error);
        throw new Error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
    }
}

/**
 * ÙŠØ­Ø¯Ù‘Ø« ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * (Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ‚ÙˆÙ… ÙÙ‚Ø· Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Firestore.
 * Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„ØµÙˆØ±Ø© ÙŠØªØ·Ù„Ø¨ Ø®Ø¯Ù…Ø© ØªØ®Ø²ÙŠÙ† Ù…Ø«Ù„ Firebase Storage Ø£Ùˆ Ø®Ø¯Ù…Ø© Ø®Ø§Ø±Ø¬ÙŠØ©.)
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} newPictureUrl - Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯.
 * @returns {Promise<boolean>} - True Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ«.
 */
async function updateProfilePicture(userId, newPictureUrl) {
    const userRef = db.collection('users').doc(userId);
    try {
        await userRef.update({ profilePictureUrl: newPictureUrl });
        console.log("Profile picture updated successfully.");
        return true;
    } catch (error) {
        console.error("Error updating profile picture:", error);
        throw new Error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ.");
    }
}

/**
 * ÙŠØ­Ø¯Ù‘Ø« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ø¬ (Status Message) Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} newStatusMessage - Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.
 * @returns {Promise<boolean>} - True Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ«.
 */
async function updateStatusMessage(userId, newStatusMessage) {
    const userRef = db.collection('users').doc(userId);
    try {
        await userRef.update({ statusMessage: newStatusMessage });
        console.log("Status message updated successfully.");
        return true;
    } catch (error) {
        console.error("Error updating status message:", error);
        throw new Error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ø¬.");
    }
}

/**
 * ÙŠØ¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø®ÙÙŠ).
 * @param {string} searchTerm - Ù…ØµØ·Ù„Ø­ Ø§Ù„Ø¨Ø­Ø«.
 * @returns {Promise<Object[]>} - ÙˆØ¹Ø¯ Ø¨Ù…ØµÙÙˆÙØ© Ù…Ù† ÙƒØ§Ø¦Ù†Ø§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙÙ‚Ø· ID, username, profilePictureUrl).
 */
async function searchUsers(searchTerm) {
    const results = [];
    const lowerCaseSearchTerm = searchTerm.toLowerCase(); // Ù„Ø¶Ù…Ø§Ù† Ø¨Ø­Ø« ØºÙŠØ± Ø­Ø³Ø§Ø³ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø³Ù…)
    const usernameQuery = await db.collection('users')
        .where('username', '>=', lowerCaseSearchTerm)
        .where('username', '<=', lowerCaseSearchTerm + '\uf8ff')
        .limit(10).get(); // Ø­Ø¯ Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«

    usernameQuery.forEach(doc => {
        const data = doc.data();
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
        results.push({ id: doc.id, username: data.username, profilePictureUrl: data.profilePictureUrl });
    });
    return results;
}

/**
 * ÙŠØ¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§.
 * @param {function} callback - Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ù…Ù† ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†.
 * @returns {function} - Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹.
 */
function getOnlineUsers(callback) {
    return db.collection('users').where('isOnline', '==', true).onSnapshot(snapshot => {
        const onlineUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        callback(onlineUsers);
    }, error => {
        console.error("Error getting online users:", error);
    });
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ---

/**
 * ÙŠÙ†Ø´Ø¦ Ù…Ù†Ø´ÙˆØ±Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹.
 * @param {string} content - Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±.
 * @param {boolean} isPrivate - Ù‡Ù„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø®Ø§Øµ (Ù„Ù„Ù…Ø¹Ø§Ø±Ù ÙÙ‚Ø·)ØŸ
 * @returns {Promise<void>}
 */
async function createPost(content, isPrivate = false) {
    if (!auth.currentUser) {
        throw new Error("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù†Ø´Ø± Ù…Ù†Ø´ÙˆØ±.");
    }
    const user = auth.currentUser;
    const userProfileDoc = await db.collection('users').doc(user.uid).get();
    if (!userProfileDoc.exists) {
        throw new Error("Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
    }
    const userData = userProfileDoc.data();

    await db.collection('posts').add({
        userId: user.uid,
        username: userData.username || user.email.split('@')[0],
        userProfilePic: userData.profilePictureUrl || defaultAvatarUrl,
        content: content,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        // Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª: Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
        reactions: {
            heart: 0, // â¤
            tears: 0, // ğŸ˜«
            clown: 0, // ğŸ¤¡
            thumbsUp: 0, // ğŸ‘
            thumbsDown: 0 // ğŸ‘
        },
        // userReactions: Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ÙˆØ­ÙŠØ¯ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø«Ù„Ø§Ù‹: { userId: 'heart' })
        userReactions: {},
        commentsCount: 0,
        isPrivate: isPrivate // Ø­Ø§Ù„Ø© Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…Ù†Ø´ÙˆØ±
    });

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await db.collection('users').doc(user.uid).update({
        postsCount: firebase.firestore.FieldValue.increment(1)
    });
}

/**
 * ÙŠØ­Ø¯Ù‘Ø« Ù…Ø­ØªÙˆÙ‰ Ù…Ù†Ø´ÙˆØ± Ù…ÙˆØ¬ÙˆØ¯.
 * @param {string} postId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±.
 * @param {string} newContent - Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù†Ø´ÙˆØ±.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©).
 * @returns {Promise<void>}
 */
async function updatePost(postId, newContent, userId) {
    const postRef = db.collection('posts').doc(postId);
    const postDoc = await postRef.get();

    if (!postDoc.exists) {
        throw new Error("Ø§Ù„Ù…Ù†Ø´ÙˆØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
    }
    if (postDoc.data().userId !== userId) {
        throw new Error("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±.");
    }

    await postRef.update({
        content: newContent,
        editedAt: firebase.firestore.FieldValue.serverTimestamp() // ÙˆÙ‚Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    });
}

/**
 * ÙŠØ­Ø°Ù Ù…Ù†Ø´ÙˆØ±Ø§Ù‹.
 * @param {string} postId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø­Ø°Ù (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©).
 * @returns {Promise<void>}
 */
async function deletePost(postId, userId) {
    const postRef = db.collection('posts').doc(postId);
    const postDoc = await postRef.get();

    if (!postDoc.exists) {
        throw new Error("Ø§Ù„Ù…Ù†Ø´ÙˆØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
    }
    if (postDoc.data().userId !== userId) {
        throw new Error("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±.");
    }

    // Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡ (Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Firestore)
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙØ¹Ù„ÙŠÙ‹Ø§ (Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª)ØŒ Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¯Ø§Ù„Ø© Cloud Function Ø£Ùˆ ØªÙ†ÙÙŠØ° Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ø®Ø§Ø¯Ù…
    // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ­Ø°Ù ÙÙ‚Ø· ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.

    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙˆØ¹Ø¯ (Promise.all) Ù„Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ Ù…Ù† Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„
    const commentsSnapshot = await postRef.collection('comments').get();
    const batch = db.batch();
    commentsSnapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
    });
    batch.delete(postRef); // Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù†ÙØ³Ù‡ Ø¨Ø¹Ø¯ Ø­Ø°Ù ØªØ¹Ù„ÙŠÙ‚Ø§ØªÙ‡

    await batch.commit();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await db.collection('users').doc(userId).update({
        postsCount: firebase.firestore.FieldValue.increment(-1)
    });
}

/**
 * ÙŠØ³ØªÙ…Ø¹ Ù„Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆÙŠØ³ØªØ¯Ø¹ÙŠ Ø¯Ø§Ù„Ø© Ø±Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±.
 * @param {function} callback - Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.
 * @returns {function} - Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹.
 */
function getPosts(callback) {
    return db.collection('posts')
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
            const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            callback(posts);
        }, error => {
            console.error("Error getting posts:", error);
            // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… alert() Ù‡Ù†Ø§. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¹Ø§Ù…Ù„ app.js Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.
        });
}

/**
 * ÙŠØ¶ÙŠÙ Ø£Ùˆ ÙŠØ²ÙŠÙ„ ØªÙØ§Ø¹Ù„Ø§Ù‹ (reaction) Ø¥Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±.
 * ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙ‡ ØªÙØ§Ø¹Ù„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„ÙƒÙ„ Ù…Ù†Ø´ÙˆØ±.
 * Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ØªÙØ§Ø¹Ù„ ÙŠØ²ÙŠÙ„Ù‡ØŒ ÙˆØ§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ØªÙØ§Ø¹Ù„ Ù…Ø®ØªÙ„Ù ÙŠØ­Ù„ Ù…Ø­Ù„Ù‡.
 * @param {string} postId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªÙØ§Ø¹Ù„.
 * @param {string} newReactionType - Ù†ÙˆØ¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹: 'heart', 'thumbsUp').
 * @returns {Promise<void>}
 */
async function addReaction(postId, userId, newReactionType) {
    const postRef = db.collection('posts').doc(postId);

    await db.runTransaction(async (transaction) => {
        const postDoc = await transaction.get(postRef);
        if (!postDoc.exists) {
            throw new Error("Ø§Ù„Ù…Ù†Ø´ÙˆØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
        }

        const postData = postDoc.data();
        const currentReactions = postData.reactions || {}; // Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ù†ÙˆØ¹ ØªÙØ§Ø¹Ù„
        const userReactions = postData.userReactions || {}; // Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø°ÙŠ Ø§Ø®ØªØ§Ø±Ù‡ ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…

        const existingUserReaction = userReactions[userId];

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ ØªÙØ§Ø¹Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
        if (existingUserReaction) {
            // Ù‚Ù… Ø¨ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            if (currentReactions[existingUserReaction] > 0) {
                currentReactions[existingUserReaction]--;
            }
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            delete userReactions[userId];
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø®ØªÙ„ÙÙ‹Ø§ Ø¹Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ§Ø¹Ù„ Ù‚Ø¯ÙŠÙ…)
        if (newReactionType && existingUserReaction !== newReactionType) {
            // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if (currentReactions[newReactionType] === undefined) {
                currentReactions[newReactionType] = 0; // ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ÙˆØ¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¬Ø¯ÙŠØ¯Ø§Ù‹
            }
            currentReactions[newReactionType]++;
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            userReactions[userId] = newReactionType;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        transaction.update(postRef, {
            reactions: currentReactions,
            userReactions: userReactions
        });
    });
}

/**
 * ÙŠØ¶ÙŠÙ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹ Ø¥Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±.
 * @param {string} postId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¹Ù„Ù‚.
 * @param {string} username - Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¹Ù„Ù‚.
 * @param {string} userProfilePic - Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø¹Ù„Ù‚.
 * @param {string} commentContent - Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚.
 * @returns {Promise<void>}
 */
async function addComment(postId, userId, username, userProfilePic, commentContent) {
    const commentsCollectionRef = db.collection('posts').doc(postId).collection('comments');
    await commentsCollectionRef.add({
        userId: userId,
        username: username,
        userProfilePic: userProfilePic,
        content: commentContent,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    await db.collection('posts').doc(postId).update({
        commentsCount: firebase.firestore.FieldValue.increment(1)
    });
}

/**
 * ÙŠØ³ØªÙ…Ø¹ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ± Ù…Ø¹ÙŠÙ† ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ.
 * @param {string} postId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±.
 * @param {function} callback - Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª.
 * @returns {function} - Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹.
 */
function getComments(postId, callback) {
    const commentsCollectionRef = db.collection('posts').doc(postId).collection('comments');
    return commentsCollectionRef.orderBy('timestamp', 'asc').onSnapshot(snapshot => {
        const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        callback(comments);
    }, error => {
        console.error("Error getting comments:", error);
    });
}

/**
 * Ø­ÙØ¸ Ù…Ù†Ø´ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸ ÙƒØ®Ø±ÙŠØ·Ø© ÙÙŠ Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} postId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­ÙØ¸Ù‡.
 * @returns {Promise<void>}
 */
async function savePost(userId, postId) {
    const userRef = db.collection('users').doc(userId);
    await userRef.update({
        [`savedPosts.${postId}`]: firebase.firestore.FieldValue.serverTimestamp() // Ù‚ÙŠÙ…Ø© timestamp Ù„Ù„ØªØ±ØªÙŠØ¨
    });
}

/**
 * Ø¥Ø²Ø§Ù„Ø© Ø­ÙØ¸ Ù…Ù†Ø´ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} postId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø­ÙØ¸Ù‡.
 * @returns {Promise<void>}
 */
async function unsavePost(userId, postId) {
    const userRef = db.collection('users').doc(userId);
    await userRef.update({
        [`savedPosts.${postId}`]: firebase.firestore.FieldValue.delete()
    });
}

/**
 * ÙŠØ³ØªÙ…Ø¹ Ù„Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {function} callback - Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.
 * @returns {function} - Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹.
 */
function getSavedPosts(userId, callback) {
    // ÙŠØ¬Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© savedPosts IDs Ù…Ù† Ù…Ù„Ù ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    return db.collection('users').doc(userId).onSnapshot(async userDoc => {
        if (userDoc.exists) {
            const savedPostsMap = userDoc.data().savedPosts || {};
            const savedPostIds = Object.keys(savedPostsMap);

            if (savedPostIds.length === 0) {
                callback([]);
                return;
            }

            // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            const chunks = [];
            for (let i = 0; i < savedPostIds.length; i += 10) {
                chunks.push(savedPostIds.slice(i, i + 10));
            }

            let allSavedPosts = [];
            for (const chunk of chunks) {
                const snapshots = await db.collection('posts').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get();
                snapshots.forEach(doc => allSavedPosts.push({ id: doc.id, ...doc.data() }));
            }
            // ÙØ±Ø² Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸ (Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©)
            allSavedPosts.sort((a, b) => (savedPostsMap[b.id]?.toDate()?.getTime() || 0) - (savedPostsMap[a.id]?.toDate()?.getTime() || 0));
            callback(allSavedPosts);
        } else {
            callback([]);
        }
    }, error => {
        console.error("Error getting saved posts:", error);
    });
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¹Ø§Ø±Ù (Acquaintances) ---

const MAX_ACQUAINTANCES = 300; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø±Ù

/**
 * ÙŠØ±Ø³Ù„ Ø·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù (Ø£Ùˆ ÙŠÙ‚Ø¨Ù„ Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙŠØµØ¨Ø­Ø§ Ù…Ø¹Ø±ÙÙŠÙ† Ù…ØªØ¨Ø§Ø¯Ù„ÙŠÙ†).
 * Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„ØªÙ†ÙÙŠØ° ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ù…ØªØ¨Ø§Ø¯Ù„Ø© ÙÙˆØ±Ù‹Ø§. Ù„Ù†Ø¸Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠ (Ù…Ø¹Ù„Ù‚/Ù…Ù‚Ø¨ÙˆÙ„)ØŒ
 * Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙØ±Ø¹ÙŠØ© Ù„Ù€ 'acquaintanceRequests' Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} currentUserId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.
 * @param {string} targetUserId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡ ÙƒÙ…Ø¹Ø±Ù.
 * @returns {Promise<void>}
 */
async function sendAcquaintanceRequest(currentUserId, targetUserId) {
    if (currentUserId === targetUserId) {
        throw new Error("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³Ùƒ ÙƒÙ…Ø¹Ø±Ù.");
    }

    const currentUserRef = db.collection('users').doc(currentUserId);
    const targetUserRef = db.collection('users').doc(targetUserId);

    const [currentUserDoc, targetUserDoc] = await Promise.all([
        currentUserRef.get(),
        targetUserRef.get()
    ]);

    if (!currentUserDoc.exists || !targetUserDoc.exists) {
        throw new Error("Ø£Ø­Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
    }

    const currentAcquaintances = currentUserDoc.data().acquaintances || {};
    const targetAcquaintances = targetUserDoc.data().acquaintances || {};

    if (Object.keys(currentAcquaintances).length >= MAX_ACQUAINTANCES) {
        throw new Error(`Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø¹Ø§Ø±Ù (${MAX_ACQUAINTANCES}).`);
    }
    if (Object.keys(targetAcquaintances).length >= MAX_ACQUAINTANCES) {
        throw new Error(`Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${targetUserDoc.data().username} ÙˆØµÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø¹Ø§Ø±Ù.`);
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Ø§ Ù…Ø¹Ø§Ø±Ù Ø¨Ø§Ù„ÙØ¹Ù„
    if (currentAcquaintances[targetUserId] || targetAcquaintances[currentUserId]) {
        throw new Error("Ø£Ù†ØªÙ… Ù…Ø¹Ø§Ø±Ù Ø¨Ø§Ù„ÙØ¹Ù„.");
    }

    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ø§Ø¯Ù„Ø© ÙÙŠ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© (Batch)
    const batch = db.batch();

    batch.update(currentUserRef, {
        [`acquaintances.${targetUserId}`]: { addedAt: firebase.firestore.FieldValue.serverTimestamp() },
        acquaintancesCount: firebase.firestore.FieldValue.increment(1)
    });
    batch.update(targetUserRef, {
        [`acquaintances.${currentUserId}`]: { addedAt: firebase.firestore.FieldValue.serverTimestamp() },
        acquaintancesCount: firebase.firestore.FieldValue.increment(1)
    });

    await batch.commit();
    console.log(`User ${currentUserId} and ${targetUserId} are now acquaintances.`);
}

/**
 * ÙŠØ²ÙŠÙ„ Ù…Ø¹Ø±ÙØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø±Ù Ø§Ù„Ù…ØªØ¨Ø§Ø¯Ù„Ø©.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø¥Ø²Ø§Ù„Ø©.
 * @param {string} acquaintanceId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø²Ø§Ù„ØªÙ‡.
 * @returns {Promise<void>}
 */
async function removeAcquaintance(userId, acquaintanceId) {
    const userRef = db.collection('users').doc(userId);
    const acquaintanceRef = db.collection('users').doc(acquaintanceId);

    const batch = db.batch();

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙˆÙ„
    batch.update(userRef, {
        [`acquaintances.${acquaintanceId}`]: firebase.firestore.FieldValue.delete(),
        acquaintancesCount: firebase.firestore.FieldValue.increment(-1)
    });
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø±Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ
    batch.update(acquaintanceRef, {
        [`acquaintances.${userId}`]: firebase.firestore.FieldValue.delete(),
        acquaintancesCount: firebase.firestore.FieldValue.increment(-1)
    });

    await batch.commit();
    console.log(`Acquaintance ${acquaintanceId} removed from ${userId}.`);
}

/**
 * ÙŠØ³ØªÙ…Ø¹ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø±Ù Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {function} callback - Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ù…Ù† ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ø±Ù.
 * @returns {function} - Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹.
 */
function getAcquaintances(userId, callback) {
    return db.collection('users').doc(userId).onSnapshot(async userDoc => {
        if (userDoc.exists) {
            const userData = userDoc.data();
            const acquaintanceIds = Object.keys(userData.acquaintances || {});
            
            if (acquaintanceIds.length === 0) {
                callback([]);
                return;
            }

            const acquaintances = await getUsersProfiles(acquaintanceIds);
            callback(acquaintances);
        } else {
            callback([]);
        }
    }, error => {
        console.error("Error getting acquaintances:", error);
    });
}

/**
 * ØªØ¨Ø¯ÙŠÙ„ Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {boolean} isPrivate - Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…Ù„Ù (true Ù„Ù„Ù‚ÙÙ„ØŒ false Ù„ÙØªØ­ Ø§Ù„Ù‚ÙÙ„).
 * @returns {Promise<void>}
 */
async function toggleProfilePrivacy(userId, isPrivate) {
    const userRef = db.collection('users').doc(userId);
    await userRef.update({ isProfilePrivate: isPrivate });
}


// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ---

/**
 * ÙŠØ¶ÙŠÙ Ù…Ø´Ø§Ø±ÙƒÙ‹Ø§ Ø¥Ù„Ù‰ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ÙŠÙ†Ø©.
 * ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¨Ø´ÙƒÙ„ Ø®Ø§Øµ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
 * @param {string} chatId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡.
 * @param {string} username - Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡.
 */
async function addParticipantToChat(chatId, userId, username) {
    const chatRef = db.collection('chats').doc(chatId);
    try {
        await chatRef.update({
            [`participants.${userId}`]: { username: username, joinedAt: firebase.firestore.FieldValue.serverTimestamp() }
        });
    } catch (error) {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹
        if (error.code === 'not-found') {
            let chatData = {
                participants: {
                    [userId]: { username: username, joinedAt: firebase.firestore.FieldValue.serverTimestamp() }
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©!',
                lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                isGroup: true, // Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù‡ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
                typingStatus: {} // Ø­Ù‚Ù„ Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
            };
            if (chatId === PUBLIC_CHAT_ID) {
                chatData.name = 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©';
                chatData.publicChat = true;
            } else if (chatId === NEWS_CHANNEL_ID) {
                chatData.name = 'Ù‚Ù†Ø§Ø© Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø±';
                chatData.newsChannel = true;
                chatData.readOnly = true; // Ù‚Ù†Ø§Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
            } else if (chatId === PUBLIC_GROUP_CHAT_ID) {
                chatData.name = 'Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©';
                chatData.publicGroup = true;
            }
            await chatRef.set(chatData);
            console.log(`Chat ${chatId} created and user ${username} added.`);
        } else {
            console.error(`Error adding user to chat ${chatId}:`, error);
            throw new Error(`ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ${error.message}`);
        }
    }
}


/**
 * ÙŠÙ†Ø´Ø¦ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø© (ÙØ±Ø¯ÙŠØ© Ø£Ùˆ Ø¬Ù…Ø§Ø¹ÙŠØ©).
 * Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©ØŒ ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø±Ø¯Ø´Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨ÙŠÙ† Ù†ÙØ³ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†.
 * @param {string[]} participantIds - Ù…ØµÙÙˆÙØ© Ù…Ù† Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†.
 * @param {string} [chatName=null] - Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª).
 * @param {boolean} [isGroup=false] - Ù‡Ù„ Ù‡ÙŠ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©ØŸ
 * @returns {Promise<string>} - ÙˆØ¹Ø¯ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©.
 */
async function createChat(participantIds, chatName = null, isGroup = false) {
    if (participantIds.length < 2) {
        throw new Error("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´Ø§Ø±ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø±Ø¯Ø´Ø©.");
    }

    if (!isGroup) {
        // Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© (1-to-1)ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±Ù Ø¯Ø±Ø¯Ø´Ø© ÙØ±ÙŠØ¯ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        const sortedParticipantIds = [...new Set(participantIds)].sort();
        const directChatId = sortedParticipantIds.join('_'); // Ù…Ø«Ø§Ù„: "user1_user2"

        const chatRef = db.collection('chats').doc(directChatId);
        const chatDoc = await chatRef.get();

        if (chatDoc.exists) {
            return directChatId; // Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        } else {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø±Ø¯Ø´Ø© ÙØ±Ø¯ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
            const participantsData = {};
            const userProfiles = await getUsersProfiles(sortedParticipantIds);
            userProfiles.forEach(user => {
                participantsData[user.id] = { username: user.username || user.email.split('@')[0] };
            });

            await chatRef.set({
                participants: participantsData,
                name: null, // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³Ù… Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
                isGroup: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: 'Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰!',
                lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
                publicChat: false,
                newsChannel: false,
                typingStatus: {}
            });
            console.log("New private chat created with ID:", directChatId);
            return directChatId;
        }
    } else {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù…Ø¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ
        if (!chatName) {
            throw new Error("ÙŠØ¬Ø¨ ØªÙˆÙÙŠØ± Ø§Ø³Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©.");
        }
        const newChatRef = db.collection('chats').doc(); // Ù…Ø¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ
        const participantsData = {};
        const userProfiles = await getUsersProfiles(participantIds);

        userProfiles.forEach(user => {
            participantsData[user.id] = { username: user.username || user.email.split('@')[0] };
        });

        await newChatRef.set({
            participants: participantsData,
            name: chatName,
            isGroup: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastMessage: 'Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!',
            lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
            publicChat: false,
            newsChannel: false,
            typingStatus: {}
        });
        console.log("New group chat created with ID:", newChatRef.id);
        return newChatRef.id;
    }
}


/**
 * ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ÙŠÙ†Ø©.
 * ÙŠØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†.
 * @param {string} chatId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 * @param {string} senderId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±Ø³Ù„.
 * @param {string} senderUsername - Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„.
 * @param {string} content - Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
 * @returns {Promise<boolean>} - True Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.
 */
async function sendMessage(chatId, senderId, senderUsername, content) {
    const chatDoc = await db.collection('chats').doc(chatId).get();
    if (!chatDoc.exists) {
        throw new Error("Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
    }
    const chatData = chatDoc.data();

    // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹
    if (chatData.newsChannel && !isAdminUser()) {
        throw new Error("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±.");
    }

    const messagesCollectionRef = db.collection('chats').doc(chatId).collection('messages');
    try {
        await messagesCollectionRef.add({
            senderId: senderId,
            senderUsername: senderUsername,
            content: content,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            readBy: {
                [senderId]: true // Ø§Ù„Ù…Ø±Ø³Ù„ ÙŠØ¹ØªØ¨Ø± Ù‚Ø¯ Ù‚Ø±Ø£ Ø±Ø³Ø§Ù„ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙˆØªØ§Ø±ÙŠØ®Ù‡Ø§ ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        await db.collection('chats').doc(chatId).update({
            lastMessage: content,
            lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        return true;
    } catch (error) {
        console.error("Error sending message:", error);
        throw new Error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.");
    }
}

/**
 * ÙŠØ³ØªÙ…Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ÙŠÙ†Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ.
 * @param {string} chatId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 * @param {function} callback - Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.
 * @returns {function} - Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹.
 */
function getMessages(chatId, callback) {
    const messagesCollectionRef = db.collection('chats').doc(chatId).collection('messages');
    return messagesCollectionRef.orderBy('timestamp', 'asc').onSnapshot(snapshot => {
        const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        callback(messages);
    }, error => {
        console.error("Error getting messages:", error);
        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¹Ø§Ù…Ù„ app.js Ù…Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    });
}

/**
 * ÙŠÙ‚ÙˆÙ… Ø¨ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯.
 * @param {string} chatId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 * @param {string[]} messageIds - Ù…ØµÙÙˆÙØ© Ø¨Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ Ù‚Ø±Ø£ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.
 */
async function markMessagesAsRead(chatId, messageIds, userId) {
    const batch = db.batch();
    messageIds.forEach(msgId => {
        const messageRef = db.collection('chats').doc(chatId).collection('messages').doc(msgId);
        batch.update(messageRef, {
            [`readBy.${userId}`]: true
        });
    });
    try {
        await batch.commit();
        // console.log(`Messages in chat ${chatId} marked as read by ${userId}`);
    } catch (error) {
        console.error("Error marking messages as read:", error);
    }
}

/**
 * ÙŠØ¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ´Ø§Ø±Ùƒ ÙÙŠÙ‡Ø§ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ÙŠÙ† ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {function} callback - Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¹ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª.
 * @returns {function} - Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹.
 */
function getParticipatingChats(userId, callback) {
    return db.collection('chats')
        .where(`participants.${userId}.username`, '!=', null) // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø§Ø±Ùƒ
        .orderBy('lastMessageAt', 'desc') // ÙØ±Ø² Ø­Ø³Ø¨ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
        .onSnapshot(snapshot => {
            const chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            callback(chats);
        }, error => {
            console.error("Error getting participating chats:", error);
        });
}

/**
 * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ÙŠÙ†Ø©.
 * @param {string} chatId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {boolean} isTyping - True Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠÙƒØªØ¨ØŒ False Ø¥Ø°Ø§ ØªÙˆÙ‚Ù.
 */
async function updateTypingStatus(chatId, userId, isTyping) {
    const chatRef = db.collection('chats').doc(chatId);
    if (isTyping) {
        await chatRef.update({
            [`typingStatus.${userId}`]: true
        });
    } else {
        await chatRef.update({
            [`typingStatus.${userId}`]: firebase.firestore.FieldValue.delete()
        });
    }
}

/**
 * ÙŠØ³ØªÙ…Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ÙŠÙ†Ø©.
 * @param {string} chatId - Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
 * @param {string} otherUserId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø± Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„ØªÙ‡.
 * @param {function} callback - Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø¹ true/false Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©.
 * @returns {function} - Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹.
 */
function listenToTypingStatus(chatId, otherUserId, callback) {
    return db.collection('chats').doc(chatId).onSnapshot(doc => {
        if (doc.exists) {
            const data = doc.data();
            const typingUsers = data.typingStatus || {};
            const isTyping = !!typingUsers[otherUserId]; // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø± ÙŠÙƒØªØ¨
            callback(isTyping);
        }
    });
}



<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙˆØ§ØµÙ„ - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„ØªÙˆØ§ØµÙ„</title>
    <!-- Ø±Ø¨Ø· Ù…Ù„Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <link rel="stylesheet" href="style.css">
    <!-- Font Awesome Icons for modern UI elements (Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø¹ØµØ±ÙŠØ©) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Cairo for Arabic text (Ø®Ø· Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚) -->
    <div id="loadingScreen" class="loading-screen active">
        <div class="spinner"></div>
        <p class="loading-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨) -->
    <div id="authScreen" class="screen auth-screen">
        <div class="auth-card">
            <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªÙˆØ§ØµÙ„!</h2>
            <form id="authForm" class="auth-form">
                <input type="email" id="authEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                <input type="password" id="authPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                <button type="submit" id="authSubmitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <p class="auth-error" id="authError"></p>
                <p class="auth-toggle-text">
                    <a href="#" id="toggleAuthMode">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="mainApp" class="screen main-app">
        <header>
            <div class="header-left">
                <h1>ØªÙˆØ§ØµÙ„</h1>
            </div>
            <nav>
                <button id="showPostsBtn" class="nav-button active">
                    <i class="fas fa-bullhorn"></i> Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
                </button>
                <button id="showChatsBtn" class="nav-button">
                    <i class="fas fa-comments"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
                </button>
                <button id="showAcquaintancesBtn" class="nav-button">
                    <i class="fas fa-users"></i> Ø§Ù„Ù…Ø¹Ø§Ø±Ù
                </button>
                <button id="showProfileBtn" class="nav-button">
                    <i class="fas fa-user-circle"></i> Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
                </button>
            </nav>
            <div class="header-right">
                <button id="toggleDarkModeBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ" class="header-icon-button">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </header>

        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† (ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©) -->
        <aside id="onlineUsersSidebar" class="online-users-sidebar">
            <h3>
                Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù† <span id="onlineUsersCount" class="online-count">(0)</span>
            </h3>
            <ul id="onlineUsersList" class="online-users-list">
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
            </ul>
        </aside>

        <main class="main-content">
            <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
            <section id="postsSection" class="section active">
                <div class="section-header">
                    <h2>Ø¢Ø®Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h2>
                    <button id="refreshPostsBtn" class="icon-button">
                        <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
                <div class="card post-input-area">
                    <textarea id="postContent" placeholder="Ù…Ø§Ø°Ø§ ÙŠØ¯ÙˆØ± ÙÙŠ Ø°Ù‡Ù†ÙƒØŸ"></textarea>
                    <div class="post-options">
                        <label class="checkbox-container">
                            <input type="checkbox" id="privatePostCheckbox">
                            <span class="checkmark"></span>
                            Ù…Ù†Ø´ÙˆØ± Ø®Ø§Øµ (Ù„Ù„Ù…Ø¹Ø§Ø±Ù ÙÙ‚Ø·)
                        </label>
                        <button id="publishPostBtn" class="primary-button">
                            <i class="fas fa-paper-plane"></i> Ù†Ø´Ø±
                        </button>
                    </div>
                </div>
                <div id="postsList" class="posts-list">
                    <!-- Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                </div>
            </section>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª -->
            <section id="chatsSection" class="section chats-section">
                <div class="chat-sidebar card">
                    <div class="chat-search-bar">
                        <input type="text" id="searchUserInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...">
                        <button id="searchUserBtn" class="icon-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="search-results-list">
                        <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
                    </div>
                    <h3>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ©</h3>
                    <div id="chatsList" class="chats-list">
                        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                    </div>
                </div>

                <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© (ØªØ¸Ù‡Ø± ÙƒØ´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø³Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨) -->
                <div id="chatContainer" class="chat-container">
                    <div class="chat-header">
                        <button id="closeChatBtn" class="header-icon-button">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <img src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©" class="chat-avatar" id="chatHeaderAvatar">
                        <div class="chat-header-info">
                            <h3 id="chatHeaderName">Ø§Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
                            <span id="chatStatus" class="chat-status"></span>
                        </div>
                        <!--
                            ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù‡Ù†Ø§
                            Ù„Ø£Ù†Ù‡Ø§ ØªØ­ØªØ§Ø¬ Ù„Ù…Ù†Ø·Ù‚ Ù…Ø¹Ù‚Ø¯ ÙŠØ®Ø±Ø¬ Ø¹Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                            Ø£Ùˆ Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ ØªØ¹Ù‚ÙŠØ¯Ø§Øª ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹.
                            <div id="chatManagement" class="chat-management" style="display: none;">
                                <button id="banUserBtn" title="Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">ğŸš«</button>
                                <button id="archiveChatBtn" title="Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">ğŸ“</button>
                                <button id="leaveChatBtn" title="Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">ğŸ‘‹</button>
                            </div>
                        -->
                    </div>
                    <div id="messagesList" class="messages-list">
                        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                    </div>
                    <form id="messageInputForm" class="message-input-form">
                        <button type="button" id="recordAudioBtn" title="Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©" class="icon-button">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <textarea id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." rows="1"></textarea>
                        <button type="button" id="emojiPickerBtn" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ" class="icon-button">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button type="submit" id="sendMessageBtn" title="Ø¥Ø±Ø³Ø§Ù„" class="primary-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <div id="emojiPicker" class="emoji-picker card">
                        <!-- Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                    </div>
                </div>
            </section>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ø±Ù -->
            <section id="acquaintancesSection" class="section">
                <div class="section-header">
                    <h2>Ù…Ø¹Ø§Ø±ÙÙŠ</h2>
                    <button id="refreshAcquaintancesBtn" class="icon-button">
                        <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
                <div id="acquaintancesList" class="card user-list-card">
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø±Ù Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
                    <div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ù…Ø¹Ø§Ø±Ù Ø¨Ø¹Ø¯.</div>
                </div>
            </section>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
            <section id="profileSection" class="section">
                <div class="section-header">
                    <h2>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h2>
                    <button id="showSettingsBtn" class="primary-button" style="display: none;">
                        <i class="fas fa-cogs"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„)
                    </button>
                </div>
                <div class="card profile-card">
                    <div class="profile-avatar-wrapper">
                        <img src="https://via.placeholder.com/150/CCCCCC/000000?text=AV" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ" id="profileAvatar" class="profile-avatar">
                        <input type="file" id="profileImageUpload" accept="image/*" style="display: none;">
                        <button id="changeAvatarBtn" class="change-avatar-btn">
                            <i class="fas fa-camera"></i> ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
                        </button>
                    </div>
                    <h3 id="profileUsername">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
                    <input type="text" id="newUsernameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="display: none;">
                    <button id="saveUsernameBtn" class="primary-button" style="display: none;">
                        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…
                    </button>
                    <span id="profileEmail" class="text-secondary">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: loading...</span>
                    <p id="profileStatusMessage" class="text-secondary">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ù…Ø­Ø¯Ø¯Ø©.</p>

                    <div class="profile-stats">
                        <span>Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª: <strong id="postsCount">0</strong></span>
                        <span>Ø§Ù„Ù…Ø¹Ø§Ø±Ù: <strong id="acquaintancesCount">0</strong></span>
                        <span>Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: <strong id="savedPostsCount">0</strong></span>
                    </div>
                    <div class="profile-actions">
                        <button id="editUsernameBtn" class="secondary-button">
                            <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…
                        </button>
                        <button id="editStatusMessageBtn" class="secondary-button">
                            <i class="fas fa-comment-alt"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©
                        </button>
                        <label class="checkbox-container">
                            <input type="checkbox" id="privateProfileCheckbox">
                            <span class="checkmark"></span>
                            Ù‚ÙÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
                        </label>
                    </div>
                </div>

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
                <div class="card saved-posts-card">
                    <h3>
                        <i class="fas fa-bookmark"></i> Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                    </h3>
                    <div id="savedPostsList" class="posts-list">
                        <!-- Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø³ØªØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
                        <div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.</div>
                    </div>
                </div>

                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„) -->
                <div id="settingsCard" class="card settings-card" style="display: none;">
                    <h3>
                        <i class="fas fa-tools"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
                    </h3>
                    <form id="settingsForm" class="settings-form">
                        <label for="apiKeyInput">API Key:</label>
                        <input type="text" id="apiKeyInput" required>

                        <label for="authDomainInput">Auth Domain:</label>
                        <input type="text" id="authDomainInput" required>

                        <label for="databaseURLInput">Database URL:</label>
                        <input type="text" id="databaseURLInput" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" >

                        <label for="projectIdInput">Project ID:</label>
                        <input type="text" id="projectIdInput" required>

                        <label for="storageBucketInput">Storage Bucket:</label>
                        <input type="text" id="storageBucketInput" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">

                        <label for="messagingSenderIdInput">Messaging Sender ID:</label>
                        <input type="text" id="messagingSenderIdInput" required>

                        <label for="appIdInput">App ID:</label>
                        <input type="text" id="appIdInput" required>

                        <button type="button" id="saveFirebaseConfigBtn" class="primary-button">
                            <i class="fas fa-save"></i> Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
                        </button>
                        <p id="firebaseConfigMessage" class="error-message"></p>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK (ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ 9.1.0 Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡) -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    
    <!-- Ù…Ù„ÙØ§Øª JavaScript Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ -->
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <script src="firestore.js"></script>
    <script src="app.js"></script>
</body>
</html>





/* public/style.css */

/* Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø®Ø· Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ù…Ù† Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap');

/* ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«ÙŠÙ… Ø§Ù„ÙØ§ØªØ­ ÙˆØ§Ù„Ø¯Ø§ÙƒÙ† */
:root {
    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«ÙŠÙ… Ø§Ù„ÙØ§ØªØ­ */
    --primary-color: #4CAF50; /* Ø£Ø®Ø¶Ø± Ø²Ù…Ø±Ø¯ÙŠ */
    --primary-dark-color: #388E3C; /* Ø£Ø®Ø¶Ø± Ø¯Ø§ÙƒÙ† */
    --accent-color: #FFC107; /* Ø£ØµÙØ± Ø°Ù‡Ø¨ÙŠ */
    --background-color: #f0f2f5; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ù„Ù„Ø®Ù„ÙÙŠØ© */
    --surface-color: #ffffff; /* Ø£Ø¨ÙŠØ¶ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø§Ø±Ø²Ø© (Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª) */
    --text-color: #333333; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
    --text-light-color: #666666; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ/Ø§Ù„Ø®ÙÙŠÙ */
    --border-color: #e0e0e0; /* Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ */
    --shadow-color: rgba(0, 0, 0, 0.1); /* Ù„ÙˆÙ† Ø§Ù„Ø¸Ù„Ø§Ù„ */
    --message-sent-bg: #DCF8C6; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© (Ø£Ø®Ø¶Ø± ÙØ§ØªØ­) */
    --message-received-bg: #E0E0E0; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© (Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­) */
    --unread-divider-color: #007bff; /* Ù„ÙˆÙ† ÙØ§ØµÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø£Ø²Ø±Ù‚) */
    --online-indicator-color: #28a745; /* Ù„ÙˆÙ† Ù…Ø¤Ø´Ø± Ø§Ù„Ø§ØªØµØ§Ù„ (Ø£Ø®Ø¶Ø±) */
    --error-color: #d32f2f; /* Ù„ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ */

    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø¯Ø§ÙƒÙ† */
    --dark-background-color: #1a202c; /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ */
    --dark-surface-color: #2d3748; /* Ù„ÙˆÙ† Ø³Ø·Ø­ Ø¯Ø§ÙƒÙ† Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø§Ø±Ø²Ø© */
    --dark-text-color: #e2e8f0; /* Ù†Øµ ÙØ§ØªØ­ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
    --dark-text-light-color: #a0aec0; /* Ù†Øµ Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
    --dark-border-color: #4a5568; /* Ø­Ø¯ÙˆØ¯ Ø¯Ø§ÙƒÙ†Ø© */
    --dark-shadow-color: rgba(0, 0, 0, 0.4); /* Ø¸Ù„Ø§Ù„ Ø£ØºÙ…Ù‚ */
    --dark-message-sent-bg: #22543d; /* Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø³Ù„Ø© Ø¯Ø§ÙƒÙ†Ø© */
    --dark-message-received-bg: #4a5568; /* Ø±Ø³Ø§Ø¦Ù„ Ù…Ø³ØªÙ„Ù…Ø© Ø¯Ø§ÙƒÙ†Ø© */
    --dark-primary-color: #68d391; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
    --dark-primary-dark-color: #48bb78; /* Ø£Ø®Ø¶Ø± Ø¯Ø§ÙƒÙ† Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
    --dark-online-indicator-color: #48bb78; /* Ù…Ø¤Ø´Ø± Ù…ØªØµÙ„ Ø¯Ø§ÙƒÙ† */
}

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
body.dark-mode {
    background-color: var(--dark-background-color);
    color: var(--dark-text-color);
}

body.dark-mode .card,
body.dark-mode header,
body.dark-mode nav,
body.dark-mode .chat-header,
body.dark-mode .message-input-form,
body.dark-mode .chat-sidebar,
body.dark-mode .online-users-sidebar,
body.dark-mode .user-item,
body.dark-mode .chat-item,
body.dark-mode .emoji-picker,
body.dark-mode .comments-section,
body.dark-mode .comment-item,
body.dark-mode .auth-card {
    background-color: var(--dark-surface-color);
    border-color: var(--dark-border-color);
    box-shadow: 0 4px 10px var(--dark-shadow-color);
}

body.dark-mode button:not(.message-status .check-icon),
body.dark-mode .primary-button,
body.dark-mode .secondary-button,
body.dark-mode .icon-button {
    background-color: var(--dark-primary-color);
    color: var(--dark-text-color); /* Ù†Øµ Ø²Ø± ÙØ§ØªØ­ */
}

body.dark-mode button:hover:not(.message-status .check-icon),
body.dark-mode .primary-button:hover,
body.dark-mode .secondary-button:hover,
body.dark-mode .icon-button:hover {
    background-color: var(--dark-primary-dark-color);
}

body.dark-mode .logout-btn {
    background-color: #f44336; /* Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ† */
    color: var(--dark-text-color);
}

body.dark-mode .logout-btn:hover {
    background-color: #d32f2f;
}

body.dark-mode input,
body.dark-mode textarea {
    background-color: var(--dark-background-color);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

body.dark-mode input::placeholder,
body.dark-mode textarea::placeholder {
    color: var(--dark-text-light-color);
}

body.dark-mode .message-item.sent .message-content {
    background-color: var(--dark-message-sent-bg);
}

body.dark-mode .message-item.received .message-content {
    background-color: var(--dark-message-received-bg);
}

body.dark-mode .check-icon {
    color: var(--dark-text-light-color); /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ù„Ù„Ø¹Ù„Ø§Ù…Ø§Øª */
}
body.dark-mode .check-icon.read {
    color: #007bff; /* Ø£Ø²Ø±Ù‚ Ù„Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© */
}

body.dark-mode .post-actions button {
    border-color: var(--dark-border-color);
    color: var(--dark-text-light-color);
}
body.dark-mode .post-actions button:hover {
    background-color: var(--dark-background-color);
    color: var(--dark-primary-color);
    border-color: var(--dark-primary-color);
}

body.dark-mode .post-actions button.delete-post-btn {
    color: #ef9a9a;
    border-color: #ef9a9a;
}
body.dark-mode .post-actions button.delete-post-btn:hover {
    background-color: #d32f2f;
    color: white;
}

body.dark-mode .post-interaction-btn {
    color: var(--dark-text-light-color);
}
body.dark-mode .post-interaction-btn.active {
    color: var(--accent-color); /* Ù„ÙˆÙ† Ù…Ù…ÙŠØ² Ù„Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
}

body.dark-mode .online-users-sidebar {
    background-color: var(--dark-surface-color);
    border-color: var(--dark-border-color);
}
body.dark-mode .online-user .online-avatar {
    border-color: var(--dark-primary-color);
}
body.dark-mode .online-user span {
    color: var(--dark-text-color);
}
body.dark-mode .online-count {
    color: var(--dark-text-light-color);
}
body.dark-mode .online-users-list li {
    color: var(--dark-text-color);
}
body.dark-mode .online-users-list li .status-indicator {
    background-color: var(--dark-online-indicator-color);
}
body.dark-mode .online-users-list li img {
    border-color: var(--dark-primary-color);
}

/* Ù‚ÙˆØ§Ø¹Ø¯ CSS Ø¹Ø§Ù…Ø© */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Cairo', sans-serif;
    direction: rtl;
    text-align: right;
    background-color: var(--background-color);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    overflow-x: hidden;
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--background-color);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
}

.loading-screen.active {
    opacity: 1;
    visibility: visible;
}

.spinner {
    border: 8px solid var(--border-color);
    border-top: 8px solid var(--primary-color);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1.2em;
    color: var(--text-color);
}

/* Ø´Ø§Ø´Ø§Øª Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚) */
.screen {
    display: none;
    flex-direction: column;
    flex-grow: 1;
    width: 100%;
}

.screen.active {
    display: flex;
}

/* Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© */
.auth-screen {
    justify-content: center;
    align-items: center;
    background-color: var(--background-color);
}

.auth-card {
    background-color: var(--surface-color);
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 8px 25px var(--shadow-color);
    width: 100%;
    max-width: 450px;
    text-align: center;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.auth-card h2 {
    color: var(--primary-color);
    margin-bottom: 30px;
    font-size: 2.2em;
    font-weight: 700;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.auth-form input {
    padding: 14px 18px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 1.1em;
    width: 100%;
    background-color: var(--background-color);
    color: var(--text-color);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.auth-form input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.25);
}

.auth-form button {
    padding: 14px 25px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.2em;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    width: 100%;
    font-weight: bold;
}

.auth-form button:hover {
    background-color: var(--primary-dark-color);
    transform: translateY(-2px);
}

.auth-form button:active {
    transform: translateY(0);
}

.auth-error {
    color: var(--error-color);
    margin-top: 20px;
    font-size: 0.95em;
    min-height: 1.2em; /* Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ© */
}

.auth-toggle-text {
    margin-top: 20px;
    font-size: 0.9em;
}

.auth-toggle-text a {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: bold;
    transition: color 0.3s ease;
}

.auth-toggle-text a:hover {
    color: var(--primary-dark-color);
    text-decoration: underline;
}

/* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
.main-app {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    background-color: var(--background-color);
}

/* Ø§Ù„Ø±Ø£Ø³ (Header) */
header {
    background-color: var(--surface-color);
    padding: 15px 25px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px var(--shadow-color);
    flex-wrap: wrap; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
    gap: 15px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

header h1 {
    color: var(--primary-color);
    font-size: 2em;
    margin: 0;
    font-weight: 700;
}

header nav {
    display: flex;
    gap: 10px;
    flex-grow: 1; /* Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    justify-content: center; /* Ù„ØªÙˆØ³ÙŠØ· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ */
    order: 1; /* ÙŠØ¸Ù‡Ø± ØªØ­Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    flex-wrap: wrap;
}

header nav .nav-button {
    background-color: transparent;
    color: var(--text-light-color);
    border: none;
    padding: 10px 18px;
    font-size: 1em;
    cursor: pointer;
    border-radius: 8px;
    transition: color 0.3s ease, background-color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
}

header nav .nav-button i {
    font-size: 1.1em;
}

header nav .nav-button:hover,
header nav .nav-button.active {
    color: var(--primary-color);
    background-color: rgba(76, 175, 80, 0.1);
}

.header-right {
    display: flex;
    gap: 10px;
    order: 2; /* ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
}

.header-icon-button {
    background: none;
    border: none;
    font-size: 1.4em;
    color: var(--text-light-color);
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: color 0.3s ease, background-color 0.3s ease;
}

.header-icon-button:hover {
    color: var(--primary-color);
    background-color: rgba(76, 175, 80, 0.1);
}

.logout-btn {
    background-color: #f44336; /* Ø£Ø­Ù…Ø± */
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.3s ease, transform 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
}

.logout-btn:hover {
    background-color: #d32f2f;
    transform: translateY(-2px);
}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† */
.online-users-sidebar {
    background-color: var(--surface-color);
    padding: 20px 15px;
    border-right: 1px solid var(--border-color); /* ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† ÙÙŠ RTL */
    box-shadow: -2px 0 8px var(--shadow-color);
    overflow-y: auto;
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    flex-shrink: 0; /* Ù„Ø§ ÙŠÙ†ÙƒÙ…Ø´ */
    width: 250px; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª */
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.online-users-sidebar h3 {
    color: var(--primary-color);
    font-size: 1.2em;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.online-users-sidebar h3::before {
    content: "â—"; /* Ù†Ù‚Ø·Ø© Ø®Ø¶Ø±Ø§Ø¡ */
    color: var(--online-indicator-color);
    font-size: 0.8em;
}

.online-count {
    font-size: 0.9em;
    color: var(--text-light-color);
    font-weight: normal;
}

.online-users-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.online-users-list li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
}

.online-users-list li:last-child {
    border-bottom: none;
}

.online-users-list li:hover {
    background-color: rgba(76, 175, 80, 0.05);
}

.online-users-list li .online-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary-color);
}

.online-users-list li span {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--text-color);
}

/* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Sections) */
.main-content {
    display: flex;
    flex-grow: 1;
    padding: 20px; /* padding Ø¹Ø§Ù… Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
    overflow-y: auto;
    background-color: var(--background-color);
}

.section {
    display: none;
    flex-direction: column;
    flex-grow: 1;
    width: 100%;
}

.section.active {
    display: flex;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.section-header h2 {
    color: var(--primary-color);
    font-size: 1.8em;
    font-weight: 700;
}

.section-header .icon-button {
    background-color: var(--primary-color);
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.3s ease, transform 0.2s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: bold;
}

.section-header .icon-button:hover {
    background-color: var(--primary-dark-color);
    transform: translateY(-2px);
}
.section-header .icon-button:active {
    transform: translateY(0);
}


/* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
.card {
    background-color: var(--surface-color);
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px var(--shadow-color);
    margin-bottom: 20px;
    transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
}

/* Ø£Ø²Ø±Ø§Ø± Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ«Ø§Ù†ÙˆÙŠØ© */
.primary-button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 1em;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
}

.primary-button:hover {
    background-color: var(--primary-dark-color);
    transform: translateY(-2px);
}
.primary-button:active {
    transform: translateY(0);
}

.secondary-button {
    background-color: #e9ecef;
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 1em;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease, color 0.3s ease;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
}

.secondary-button:hover {
    background-color: #dee2e6;
    transform: translateY(-2px);
    color: var(--primary-color); /* ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
}
.secondary-button:active {
    transform: translateY(0);
}

/* Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª */
.post-input-area {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.post-input-area textarea {
    width: 100%;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    font-family: 'Cairo', sans-serif;
    font-size: 1em;
    resize: vertical;
    min-height: 100px;
    background-color: var(--background-color);
    color: var(--text-color);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.post-input-area textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.25);
}

.post-options {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
}

/* ØªØµÙ…ÙŠÙ… Checkbox Ù…Ø®ØµØµ */
.checkbox-container {
    display: block;
    position: relative;
    padding-right: 35px; /* Ù…Ø³Ø§ÙØ© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø®ØµØµØ© */
    margin-bottom: 12px;
    cursor: pointer;
    font-size: 0.95em;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    color: var(--text-light-color);
}

.checkbox-container input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.checkmark {
    position: absolute;
    top: 0;
    right: 0;
    height: 25px;
    width: 25px;
    background-color: var(--background-color);
    border: 2px solid var(--border-color);
    border-radius: 5px;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

.checkbox-container:hover input ~ .checkmark {
    background-color: #ccc;
}

.checkbox-container input:checked ~ .checkmark {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.checkmark:after {
    content: "";
    position: absolute;
    display: none;
}

.checkbox-container input:checked ~ .checkmark:after {
    display: block;
}

.checkbox-container .checkmark:after {
    left: 9px;
    top: 5px;
    width: 8px;
    height: 14px;
    border: solid white;
    border-width: 0 3px 3px 0;
    -webkit-transform: rotate(45deg);
    -ms-transform: rotate(45deg);
    transform: rotate(45deg);
}


.posts-list {
    display: flex;
    flex-direction: column;
    gap: 25px;
}

.post-item {
    background-color: var(--surface-color);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 4px 10px var(--shadow-color);
    border: 1px solid var(--border-color);
    transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
}

.post-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.post-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary-color);
}

.post-username {
    font-weight: bold;
    color: var(--primary-dark-color);
    font-size: 1.2em;
    flex-grow: 1; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
}

.post-content {
    font-size: 1em;
    line-height: 1.7;
    margin-bottom: 15px;
    color: var(--text-color);
    white-space: pre-wrap; /* Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ */
    word-wrap: break-word; /* Ù„ÙƒØ³Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© */
}

.post-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
    color: var(--text-light-color);
    border-top: 1px solid var(--border-color);
    padding-top: 15px;
    margin-top: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.post-footer .time {
    flex-grow: 1;
}

.post-interactions {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.reactions-container {
    display: flex;
    gap: 8px;
}

.reaction-btn {
    background: none;
    border: none;
    font-size: 1.6em; /* Ø­Ø¬Ù… Ø£ÙƒØ¨Ø± Ù„Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
    cursor: pointer;
    color: var(--text-light-color);
    transition: color 0.2s ease, transform 0.2s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px;
    border-radius: 5px;
}

.reaction-btn:hover {
    transform: scale(1.1);
    background-color: rgba(0, 0, 0, 0.05);
}

.reaction-btn.active {
    color: var(--accent-color);
    font-weight: bold;
}

.reaction-count {
    font-size: 0.6em; /* Ø­Ø¬Ù… Ø£ØµØºØ± Ù„Ù„Ø¹Ø¯Ø¯ */
    color: var(--text-light-color);
}

.comment-btn, .save-post-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.1em;
    color: var(--text-light-color);
    margin-left: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    transition: color 0.3s ease, background-color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.comment-btn:hover, .save-post-btn:hover {
    color: var(--primary-color);
    background-color: rgba(76, 175, 80, 0.05);
}

/* Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± (ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù) */
.post-actions {
    margin-left: auto; /* ÙŠØ¯ÙØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ† ÙÙŠ RTL */
    display: flex;
    gap: 10px;
}

.post-actions button {
    background: none;
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    color: var(--text-light-color);
    transition: all 0.2s ease;
}

.post-actions button:hover {
    background-color: var(--background-color);
    color: var(--primary-color);
    border-color: var(--primary-color);
}

.post-actions button.delete-post-btn {
    color: #f44336;
    border-color: #f44336;
}
.post-actions button.delete-post-btn:hover {
    background-color: #f44336;
    color: white;
}

/* Ø­Ù‚Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± */
.edit-post-textarea {
    width: 100%;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    font-family: 'Cairo', sans-serif;
    font-size: 1em;
    resize: vertical;
    min-height: 100px;
    margin-bottom: 15px;
    background-color: var(--background-color);
    color: var(--text-color);
}


/* Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
.comments-section {
    margin-top: 20px;
    border-top: 1px solid var(--border-color);
    padding-top: 20px;
    background-color: rgba(0, 0, 0, 0.02); /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© */
    border-radius: 10px;
    padding: 15px;
}

.comments-section h4 {
    color: var(--primary-dark-color);
    margin-bottom: 15px;
    font-size: 1.1em;
}

.comment-input-area {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.comment-input-area textarea {
    flex-grow: 1;
    padding: 10px 15px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-family: 'Cairo', sans-serif;
    font-size: 0.95em;
    resize: vertical;
    min-height: 50px;
    background-color: var(--background-color);
    color: var(--text-color);
}

.comment-input-area .primary-button {
    padding: 10px 18px;
    font-size: 0.95em;
}

.comments-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.comment-item {
    background-color: var(--surface-color); /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
    padding: 12px 18px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    display: flex;
    align-items: flex-start;
    gap: 12px;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
}

.comment-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary-color);
    flex-shrink: 0;
}

.comment-content-wrapper {
    flex-grow: 1;
}

.comment-author {
    font-weight: bold;
    color: var(--primary-color);
    font-size: 1em;
    margin-bottom: 5px;
}

.comment-text {
    font-size: 0.95em;
    color: var(--text-color);
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.comment-time {
    font-size: 0.8em;
    color: var(--text-light-color);
    margin-top: 8px;
    text-align: left;
}

/* Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
.profile-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    text-align: center;
    padding: 30px;
}

.profile-avatar-wrapper {
    position: relative;
    width: 150px;
    height: 150px;
    border-radius: 50%;
    border: 5px solid var(--primary-color);
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
}

.profile-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.change-avatar-btn {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 8px 0;
    font-size: 0.9em;
    cursor: pointer;
    text-align: center;
    border: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px;
}

.profile-avatar-wrapper:hover .change-avatar-btn {
    opacity: 1;
}

.profile-avatar-wrapper .change-avatar-btn i {
    font-size: 1.1em;
}

.profile-username {
    font-size: 2em;
    font-weight: bold;
    color: var(--primary-dark-color);
    margin-bottom: 5px;
}

.text-secondary {
    font-size: 1em;
    color: var(--text-light-color);
    margin-bottom: 10px;
}

#newUsernameInput {
    display: none;
    width: 70%;
    padding: 10px 15px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 1em;
    text-align: center;
    margin-top: 10px;
    margin-bottom: 15px;
    background-color: var(--background-color);
    color: var(--text-color);
}

#saveUsernameBtn {
    display: none;
    margin-top: 10px;
    min-width: 150px; /* Ù„Ø¶Ù…Ø§Ù† Ø­Ø¬Ù… ÙƒØ§ÙÙ */
}

.profile-stats {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 25px;
    margin-top: 20px;
    font-size: 1em;
    color: var(--text-light-color);
    border-top: 1px solid var(--border-color);
    padding-top: 20px;
    width: 100%;
}

.profile-stats span strong {
    color: var(--primary-dark-color);
    font-size: 1.2em;
    margin-left: 5px;
}

.profile-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 20px;
    justify-content: center;
}

/* Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase */
.settings-card {
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    margin-top: 30px;
}

.settings-card h3 {
    margin-bottom: 20px;
    color: var(--primary-color);
    font-size: 1.3em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.settings-form {
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.settings-form label {
    font-weight: bold;
    color: var(--text-light-color);
    margin-bottom: 5px;
    display: block;
}

.settings-form input {
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 0.95em;
    width: 100%;
    background-color: var(--background-color);
    color: var(--text-color);
}

#firebaseConfigMessage {
    margin-top: 20px;
    font-weight: bold;
    text-align: center;
}


/* Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ø±Ù ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© */
.saved-posts-card, .user-list-card { /* ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… user-list-card Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ù…Ø¹Ø§Ø±Ù */
    margin-top: 30px;
    background-color: var(--surface-color);
}

.saved-posts-card h3, .user-list-card h3 {
    margin-bottom: 20px;
    color: var(--primary-color);
    font-size: 1.3em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-item, .chat-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s ease, box-shadow 0.2s ease;
    border-radius: 10px; /* Ù„Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨ØµØ±ÙŠ */
    margin-bottom: 10px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
}

.user-item:hover, .chat-item:hover, .chat-item.active {
    background-color: rgba(76, 175, 80, 0.05);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
}
.user-item:last-child, .chat-item:last-child {
    border-bottom: none;
}


.user-avatar, .chat-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary-color);
    flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
}

.chat-item-content {
    flex-grow: 1;
}

.chat-item h3, .user-item h3 {
    font-size: 1.2em;
    margin: 0;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
}

.chat-item .last-message {
    font-size: 0.95em;
    color: var(--text-light-color);
    margin: 5px 0 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px; /* Ù„ØªÙ‚ÙŠÙŠØ¯ Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© */
}

.chat-item .time {
    font-size: 0.8em;
    color: var(--text-light-color);
    flex-shrink: 0;
}

/* Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ù†Ù‚Ø·Ø© Ø®Ø¶Ø±Ø§Ø¡) */
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--online-indicator-color);
    display: inline-block;
    margin-left: 5px; /* Ù…Ø³Ø§ÙØ© Ø¹Ù† Ø§Ù„Ù†Øµ */
    flex-shrink: 0;
}


/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© */
.chat-container {
    flex-grow: 1;
    display: none;
    flex-direction: column;
    position: absolute; /* Ù„Ø¬Ø¹Ù„Ù‡Ø§ ÙÙˆÙ‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--background-color);
    z-index: 10; /* ÙÙˆÙ‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ */
    transition: transform 0.3s ease; /* Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø³Ù„Ø³ */
}

.chat-container.active {
    display: flex;
    transform: translateX(0);
}

.chat-container:not(.active) {
    transform: translateX(100%); /* ÙŠØ¯ÙØ¹ Ù„Ù„Ø®Ø§Ø±Ø¬ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† ÙÙŠ RTL */
}


.chat-header {
    background-color: var(--surface-color);
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 8px var(--shadow-color);
    flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„Ø±Ø£Ø³ Ù…Ù† Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.chat-header .header-icon-button { /* Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…Ø· Ø²Ø± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙŠ Ø§Ù„Ø±Ø£Ø³ */
    font-size: 1.5em;
    margin-left: 10px;
}

.chat-header .chat-avatar {
    width: 55px;
    height: 55px;
    border: 3px solid var(--primary-color);
}

.chat-header-info {
    flex-grow: 1;
}

.chat-header-info h3 {
    margin: 0;
    font-size: 1.3em;
    color: var(--text-color);
    font-weight: 700;
}

.chat-status {
    font-size: 0.9em;
    color: var(--text-light-color);
    margin-top: 5px;
}

.messages-list {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column-reverse; /* Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰ */
    gap: 15px;
}

/* ÙØ§ØµÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.unread-divider {
    text-align: center;
    margin: 20px 0;
    font-size: 0.95em;
    color: var(--unread-divider-color);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.unread-divider::before,
.unread-divider::after {
    content: '';
    flex-grow: 1;
    height: 1px;
    background-color: var(--unread-divider-color);
    margin: 0 15px;
}


.message-item {
    display: flex;
    align-items: flex-end; /* Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
    gap: 10px;
    max-width: 85%; /* Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¢Ø®Ø± */
    animation: fadeInMessage 0.3s ease-out;
}

@keyframes fadeInMessage {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-item.sent {
    align-self: flex-start; /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† ÙÙŠ RTL */
    flex-direction: row-reverse; /* Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± */
}

.message-item.received {
    align-self: flex-end; /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± ÙÙŠ RTL */
    flex-direction: row;
}

.message-item .message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--border-color);
    flex-shrink: 0;
}

.message-content {
    background-color: var(--message-received-bg);
    padding: 12px 18px;
    border-radius: 20px;
    position: relative;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    color: var(--text-color);
    word-wrap: break-word;
    white-space: pre-wrap;
    flex-grow: 0;
    max-width: calc(100% - 50px); /* 40px avatar + 10px gap */
    font-size: 1em;
    line-height: 1.6;
}

.message-item.sent .message-content {
    background-color: var(--message-sent-bg);
    border-bottom-left-radius: 20px;
    border-top-left-radius: 20px;
    border-bottom-right-radius: 5px; /* Ø°ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    border-top-right-radius: 20px;
}

.message-item.received .message-content {
    border-bottom-right-radius: 20px;
    border-top-right-radius: 20px;
    border-bottom-left-radius: 5px; /* Ø°ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    border-top-left-radius: 20px;
}

.message-content .message-sender {
    font-size: 0.85em;
    font-weight: bold;
    color: var(--primary-dark-color);
    margin-bottom: 5px;
    text-align: right;
}

.message-content p {
    margin: 0;
}

.message-time {
    font-size: 0.75em;
    color: var(--text-light-color);
    margin-top: 8px;
    text-align: left;
}

.message-item.sent .message-time {
    text-align: right;
}

.message-status {
    position: absolute;
    bottom: 5px;
    right: 5px; /* ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØµØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© */
    display: flex;
    gap: 3px;
}

.message-item.sent .message-status {
    left: 5px; /* Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© ØªÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± */
    right: auto;
}

.check-icon {
    font-size: 0.8em;
    color: var(--text-light-color); /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ */
}

.check-icon.read {
    color: #007bff; /* Ø£Ø²Ø±Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */
}

.message-input-form {
    display: flex;
    padding: 15px;
    background-color: var(--surface-color);
    border-top: 1px solid var(--border-color);
    gap: 10px;
    align-items: flex-end; /* Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø£Ø³ÙÙ„ */
    flex-shrink: 0; /* Ù„Ø§ ÙŠÙ†ÙƒÙ…Ø´ */
}

.message-input-form textarea {
    flex-grow: 1;
    padding: 12px 18px;
    border: 1px solid var(--border-color);
    border-radius: 25px;
    font-family: 'Cairo', sans-serif;
    font-size: 1em;
    resize: none;
    min-height: 45px;
    max-height: 150px; /* Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙ…Ø¯Ø¯ Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ */
    overflow-y: auto;
    background-color: var(--background-color);
    color: var(--text-color);
}

.message-input-form .icon-button {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    font-size: 1.3em;
    padding: 0; /* Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ */
    flex-shrink: 0;
}

.message-input-form .primary-button {
    width: 50px;
    height: 45px;
    border-radius: 25px; /* Ø´ÙƒÙ„ Ø¨ÙŠØ¶Ø§ÙˆÙŠ Ù„Ù„Ù…Ø³Ø© Ø¬Ù…Ø§Ù„ÙŠØ© */
    font-size: 1.3em;
    padding: 0;
    flex-shrink: 0;
}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
.emoji-picker {
    position: absolute;
    bottom: 80px; /* ÙÙˆÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    right: 15px;
    width: 280px;
    background-color: var(--surface-color);
    border-radius: 15px;
    box-shadow: 0 5px 20px var(--shadow-color);
    padding: 15px;
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    flex-wrap: wrap;
    gap: 8px;
    z-index: 100;
}

.emoji-picker.active {
    display: flex;
}

.emoji-item {
    font-size: 1.8em;
    cursor: pointer;
    padding: 5px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}

.emoji-item:hover {
    background-color: var(--background-color);
}


/* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§Ø±ØºØ© / Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
.empty, .loading, .error-message {
    text-align: center;
    color: var(--text-light-color);
    padding: 20px;
    font-size: 1.1em;
    margin: 20px 0;
}

.error-message {
    color: var(--error-color);
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù… Ù„Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important; /* Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­ÙˆÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø·ÙŠÙ„ */
}


/* ØªØ®Ø·ÙŠØ· Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 768 Ø¨ÙƒØ³Ù„) */
@media (min-width: 768px) {
    .main-app {
        flex-direction: row; /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶Ù‡Ø§ */
    }

    header nav {
        order: 0; /* ÙŠØ¹ÙˆØ¯ Ù„Ù…ÙƒØ§Ù†Ù‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ */
        flex-grow: 0;
    }

    .main-content {
        flex-grow: 1;
        padding: 25px; /* padding Ø£ÙƒØ¨Ø± Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
    }

    .online-users-sidebar {
        display: flex; /* ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
    }

    .chats-section {
        display: flex;
        flex-direction: row; /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† ÙˆÙ…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± */
        flex-grow: 1;
        padding: 0; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ padding Ù…Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø§Øª */
        overflow: hidden;
    }

    .chat-sidebar {
        width: 320px; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© */
        border-left: 1px solid var(--border-color);
        border-right: none;
        box-shadow: none;
        flex-shrink: 0;
    }

    .chat-container {
        position: relative; /* ÙŠØ¹ÙˆØ¯ Ù„ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ */
        width: auto;
        height: auto;
        z-index: 1;
        transform: translateX(0) !important; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
    }

    .chat-header .close-chat-btn {
        display: none; /* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠ ÙÙŠ Ø´Ø§Ø´Ø© ÙƒØ¨ÙŠØ±Ø© */
    }

    /* Ù„Ø¶Ù…Ø§Ù† ØªÙˆØ³ÙŠØ· Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¸Ø§Ù‡Ø±Ø§Ù‹ */
    #postsSection, #profileSection, #acquaintancesSection {
        max-width: calc(100% - 250px); /* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù†Ø§Ù‚Øµ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        margin-right: auto; /* ÙŠØ¯ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ÙŠØ³Ø§Ø± */
        margin-left: auto; /* ÙŠØ¯ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ÙŠÙ…ÙŠÙ† */
    }
}

/* ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Ø£Ù‚Ù„ Ù…Ù† 768 Ø¨ÙƒØ³Ù„) */
@media (max-width: 767px) {
    header {
        flex-direction: column;
        gap: 15px;
    }

    header h1 {
        font-size: 1.6em;
    }

    header nav {
        width: 100%;
        justify-content: space-around;
        gap: 5px;
    }

    header nav .nav-button {
        padding: 8px 10px;
        font-size: 0.9em;
        gap: 5px;
    }

    .logout-btn, .header-icon-button {
        padding: 6px 12px;
        font-size: 0.85em;
        margin-top: 10px;
    }

    .header-right {
        width: 100%;
        justify-content: center;
        order: 3;
    }

    .main-content {
        padding: 15px;
    }

    .auth-card {
        padding: 30px;
    }

    .section-header h2 {
        font-size: 1.5em;
    }

    .section-header .icon-button {
        font-size: 0.8em;
        padding: 6px 12px;
    }

    .chat-sidebar {
        width: 100%;
        border-left: none;
        border-bottom: 1px solid var(--border-color);
    }

    .profile-card {
        padding: 20px;
    }

    .profile-avatar-wrapper {
        width: 100px;
        height: 100px;
        border-width: 3px;
    }

    .profile-username {
        font-size: 1.6em;
    }

    .profile-stats {
        flex-direction: column;
        gap: 15px;
        padding-top: 15px;
    }

    .profile-actions {
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }

    .profile-actions button {
        width: 100%;
    }

    .message-item {
        max-width: 95%; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    }

    .emoji-picker {
        width: 250px;
        bottom: 70px;
    }
}



